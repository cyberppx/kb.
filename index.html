<!DOCTYPE html>
<html class="light" lang="tr">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>kb. - Kayıp/Buluntu Platformu</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,400&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Custom Config -->
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary-accent": "#8e8d8a",
                        "charcoal": "#1a1a1a",
                        "off-white": "#faf9f6",
                        "border-color": "#e5e5e5",
                        "found-green": "#059669",
                        "lost-red": "#dc2626"
                    },
                    fontFamily: {
                        "serif": ["Cormorant Garamond", "serif"],
                        "sans": ["Inter", "sans-serif"]
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'float': 'float 6s ease-in-out infinite',
                        'text-shimmer': 'textShimmer 3s infinite linear',
                        'pulse-glow': 'pulseGlow 2s infinite'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-10px)' }
                        },
                        textShimmer: {
                            '0%': { backgroundPosition: '200% center' },
                            '100%': { backgroundPosition: '-200% center' }
                        },
                        pulseGlow: {
                            '0%, 100%': { opacity: 1 },
                            '50%': { opacity: 0.7 }
                        }
                    },
                    screens: {
                        'xs': '475px',
                        '3xl': '1920px',
                        '4xl': '2560px',
                    }
                },
            },
        }
    </script>

    <style>
        @layer base {
            body {
                @apply bg-off-white text-charcoal font-sans antialiased;
                min-height: max(884px, 100dvh);
            }
            h1, h2, h3 {
                @apply font-serif;
            }
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .thin-border {
            border: 0.5px solid #e5e5e5;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        .selection\:bg-primary-accent *::selection {
            background-color: #8e8d8a;
            color: white;
        }
        
        /* PC için optimize görseller */
        .item-image {
            height: 70vh;
            max-height: 700px;
            object-fit: cover;
        }
        
        @media (max-width: 1024px) {
            .item-image {
                height: 60vh;
                max-height: 500px;
            }
        }
        
        @media (max-width: 768px) {
            .item-image {
                height: 50vh;
                max-height: 400px;
            }
        }
        
        /* PC için geniş konteyner */
        .container-pc {
            max-width: 1600px;
            margin-left: auto;
            margin-right: auto;
            padding-left: 2rem;
            padding-right: 2rem;
        }
        
        @media (min-width: 1920px) {
            .container-pc {
                max-width: 1800px;
                padding-left: 3rem;
                padding-right: 3rem;
            }
        }
        
        /* PC için Hero bölümü */
        @media (min-width: 1024px) {
            .hero-title {
                font-size: 5rem;
                line-height: 1.1;
            }
            .hero-subtitle {
                font-size: 1.125rem;
                letter-spacing: 0.25em;
            }
        }
        
        @media (min-width: 1280px) {
            .hero-title {
                font-size: 6rem;
            }
        }
        
        @media (min-width: 1920px) {
            .hero-title {
                font-size: 7rem;
            }
        }
        
        /* Leaflet map fixes */
        .leaflet-container {
            font-family: 'Inter', sans-serif !important;
        }
        
        .custom-popup .leaflet-popup-content-wrapper {
            border-radius: 12px;
            padding: 0;
            overflow: hidden;
            background: white;
        }
        
        .custom-popup .leaflet-popup-content {
            margin: 0;
            width: 320px !important;
        }
        
        .custom-popup .leaflet-popup-tip {
            background: white;
        }
        
        /* FIX: Ensure popup is above everything */
        .leaflet-popup {
            z-index: 9999 !important;
        }
        
        /* Item detail popup */
        .detail-popup {
            max-width: 900px;
            width: 90vw;
        }
        
        @media (min-width: 768px) {
            .detail-popup {
                width: 80vw;
            }
        }
        
        @media (min-width: 1024px) {
            .detail-popup {
                width: 800px;
            }
        }
        
        @media (min-width: 1536px) {
            .detail-popup {
                width: 900px;
            }
        }
        
        .map-mini {
            height: 250px;
            border-radius: 12px;
            overflow: hidden;
        }
        
        @media (min-width: 1024px) {
            .map-mini {
                height: 300px;
            }
        }
        
        /* Yeni konum seçme haritası için */
        .location-map {
            height: 300px;
            border-radius: 12px;
            overflow: hidden;
        }
        
        @media (min-width: 768px) {
            .location-map {
                height: 350px;
            }
        }
        
        @media (min-width: 1024px) {
            .location-map {
                height: 400px;
            }
        }
        
        /* Konum seçme marker'ı için */
        .location-marker {
            background-color: #dc2626;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            cursor: pointer;
        }
        
        .selected-location {
            background-color: #059669;
        }
        
        .bottom-nav-blur {
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }
        
        /* Grid optimization for PC */
        @media (min-width: 1024px) {
            .items-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 2.5rem;
            }
            
            .item-card {
                max-width: 500px;
                margin: 0 auto;
            }
        }
        
        @media (min-width: 1280px) {
            .items-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 3rem;
            }
        }
        
        @media (min-width: 1536px) {
            .items-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 3rem;
            }
        }
        
        /* PC için daha geniş header */
        @media (min-width: 1024px) {
            header {
                padding-left: 3rem;
                padding-right: 3rem;
            }
            
            .brand-logo {
                font-size: 2.5rem;
            }
        }
        
        /* Fix for map popup overlapping */
        .leaflet-pane {
            z-index: 400;
        }
        
        .leaflet-top,
        .leaflet-bottom {
            z-index: 999;
        }
        
        /* Shimmer text effect */
        .shimmer-text {
            background: linear-gradient(
                90deg,
                #1a1a1a 0%,
                #8e8d8a 25%,
                #1a1a1a 50%,
                #8e8d8a 75%,
                #1a1a1a 100%
            );
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Floating dots */
        .floating-dots {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .floating-dot {
            position: absolute;
            background-color: #8e8d8a;
            border-radius: 50%;
            opacity: 0.15;
        }
        
        /* PC için istatistik kartları */
        .stat-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.05);
        }
        
        /* PC için bottom nav iyileştirmesi */
        @media (min-width: 1024px) {
            nav {
                max-width: 500px;
                margin-left: auto;
                margin-right: auto;
                left: 0;
                right: 0;
            }
            
            .nav-button {
                transition: all 0.3s ease;
            }
            
            .nav-button:hover {
                transform: scale(1.1);
            }
        }
        
        /* PC için form alanları */
        @media (min-width: 1024px) {
            .form-container {
                max-width: 700px;
                margin-left: auto;
                margin-right: auto;
            }
            
            .form-input {
                padding: 1rem 1.5rem;
                font-size: 1rem;
            }
            
            .form-button {
                padding: 1rem 2rem;
                font-size: 1rem;
            }
        }
        
        /* PC için daha büyük harita */
        @media (min-width: 1024px) {
            #turkey-map {
                height: 500px;
            }
        }
        
        @media (min-width: 1536px) {
            #turkey-map {
                height: 600px;
            }
        }
        
        /* PC için profil sayfası düzeni */
        @media (min-width: 1024px) {
            .profile-stats {
                grid-template-columns: repeat(3, 1fr);
                gap: 2rem;
            }
            
            .profile-stats > div {
                padding: 2rem;
            }
        }
        
        /* Smooth transitions */
        * {
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        
        /* Konum seçme butonu */
        .location-select-btn {
            position: relative;
            overflow: hidden;
        }
        
        .location-select-btn.active {
            background-color: #059669;
            color: white;
        }
        
        .location-select-btn.active:hover {
            background-color: #047857;
        }
        
        .selected-location-info {
            background-color: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
        }
        
        /* Profil Düzenleme Modal */
        .profile-edit-modal {
            max-width: 500px;
            width: 90vw;
        }
        
        @media (min-width: 768px) {
            .profile-edit-modal {
                width: 450px;
            }
        }
        
        /* Profil avatar */
        .profile-avatar {
            width: 120px;
            height: 120px;
            object-fit: cover;
        }
        
        @media (min-width: 768px) {
            .profile-avatar {
                width: 150px;
                height: 150px;
            }
        }
        
        /* Bio alanı */
        .bio-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* PC için yatay düzen */
        @media (min-width: 768px) {
            .profile-horizontal {
                display: flex;
                gap: 3rem;
                align-items: flex-start;
            }
            
            .profile-sidebar {
                width: 300px;
                flex-shrink: 0;
            }
            
            .profile-main {
                flex: 1;
            }
        }
        
        /* PC için arama çubuğu */
        @media (min-width: 1024px) {
            .search-container {
                max-width: 500px;
                margin: 0 auto 2rem auto;
            }
        }
        
        /* Gradient border */
        .gradient-border {
            border: 2px solid transparent;
            background: linear-gradient(white, white) padding-box,
                        linear-gradient(to right, #8e8d8a, #1a1a1a) border-box;
        }
        
        /* Custom scrollbar for PC */
        @media (min-width: 768px) {
            .custom-scrollbar::-webkit-scrollbar {
                width: 8px;
            }
            
            .custom-scrollbar::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 4px;
            }
            
            .custom-scrollbar::-webkit-scrollbar-thumb {
                background: #8e8d8a;
                border-radius: 4px;
            }
            
            .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                background: #666;
            }
        }
    </style>
</head>
<body class="selection:bg-primary-accent selection:text-white">

<!-- Authentication Modal -->
<div id="auth-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 fade-in hidden">
    <div class="bg-white rounded-2xl p-8 w-full max-w-md shadow-2xl slide-up relative overflow-hidden">
        <div class="text-center mb-8">
            <div class="w-16 h-16 bg-charcoal rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="material-symbols-outlined text-white text-3xl">search_check</span>
            </div>
            <h2 id="auth-title" class="text-2xl font-serif font-light italic mb-2">Giriş Yap</h2>
            <p class="text-charcoal/40 text-sm">Topluluğa katıl, kayıp ve buluntuları yönet</p>
        </div>
        
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-charcoal/60 mb-2">E-posta</label>
                <input type="email" id="auth-email" placeholder="ornek@email.com" 
                       class="w-full px-4 py-3 bg-off-white border thin-border rounded-lg focus:ring-1 focus:ring-charcoal focus:border-transparent outline-none text-sm form-input">
            </div>
            
            <div>
                <label class="block text-sm font-medium text-charcoal/60 mb-2">Şifre</label>
                <input type="password" id="auth-pass" placeholder="••••••••" 
                       class="w-full px-4 py-3 bg-off-white border thin-border rounded-lg focus:ring-1 focus:ring-charcoal focus:border-transparent outline-none text-sm form-input">
            </div>
            
            <button onclick="handleAuth()" id="auth-btn" 
                    class="w-full py-3 bg-charcoal text-white font-medium rounded-lg hover:bg-charcoal/90 transition text-sm form-button">
                <span id="auth-btn-text">GİRİŞ YAP</span>
            </button>
            
            <div class="text-center pt-4">
                <p onclick="toggleAuthMode()" id="auth-toggle" 
                   class="text-sm text-charcoal/60 hover:text-charcoal cursor-pointer transition">
                    Hesabınız yok mu? <span class="underline">Kayıt Ol</span>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loading-overlay" class="fixed inset-0 z-[60] bg-black/40 backdrop-blur-sm flex items-center justify-center hidden fade-in">
    <div class="bg-white p-6 rounded-xl shadow-xl">
        <div class="flex flex-col items-center gap-3">
            <div class="w-12 h-12 border-2 border-charcoal/20 border-t-charcoal rounded-full animate-spin"></div>
            <p class="text-sm text-charcoal/60">Yükleniyor...</p>
        </div>
    </div>
</div>

<!-- Item Detail Popup -->
<div id="detail-modal" class="fixed inset-0 z-[9999] flex items-center justify-center p-4 bg-black/60 fade-in hidden">
    <div class="detail-popup bg-white rounded-2xl overflow-hidden shadow-2xl slide-up max-h-[90vh] overflow-y-auto">
        <!-- Content will be loaded here -->
    </div>
</div>

<!-- Profile Edit Modal -->
<div id="profile-edit-modal" class="fixed inset-0 z-[9999] flex items-center justify-center p-4 bg-black/60 fade-in hidden">
    <div class="profile-edit-modal bg-white rounded-2xl overflow-hidden shadow-2xl slide-up max-h-[90vh] overflow-y-auto">
        <!-- Profile edit content will be loaded here -->
    </div>
</div>

<!-- Header -->
<header class="sticky top-0 z-40 bg-off-white/80 backdrop-blur-md px-6 lg:px-12 py-5 flex items-center justify-between">
    <div class="flex items-center gap-2 cursor-pointer" onclick="showPage('home')">
        <span class="font-serif italic text-2xl lg:text-3xl brand-logo tracking-tighter">kb.</span>
    </div>
    
    <div id="header-profile" class="flex items-center gap-3">
        <!-- User avatar will be inserted here -->
    </div>
</header>

<!-- Main Content -->
<main class="flex-1 pb-32 container-pc">
    <!-- Ana Sayfa -->
    <section id="page-home" class="space-y-12 lg:space-y-20 fade-in">
        <!-- Hero Section -->
        <section class="px-6 lg:px-12 pt-8 lg:pt-16 pb-12 lg:pb-20 text-center relative overflow-hidden">
            <!-- Floating dots background -->
            <div class="floating-dots" id="floating-dots"></div>
            
            <h1 class="hero-title font-serif font-light italic mb-4 lg:mb-6">Kayıp olanı bul.</h1>
            <p class="hero-subtitle text-charcoal/40 font-light tracking-widest uppercase mb-12 lg:mb-16">Özenle seçilmiş kayıp & buluntu platformu</p>
            
            <!-- Güzel Söz Bölümü -->
            <div class="max-w-4xl mx-auto px-4 py-12 lg:py-20">
                <div class="relative">
                    <!-- Efektli arkaplan -->
                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-off-white/50 to-transparent blur-xl opacity-30"></div>
                    
                    <!-- Ana içerik -->
                    <div class="relative">
                        <div class="text-center mb-8 lg:mb-12">
                            <div class="w-20 h-20 lg:w-24 lg:h-24 mx-auto mb-6 lg:mb-8 rounded-full bg-gradient-to-br from-charcoal/5 to-primary-accent/10 flex items-center justify-center border border-charcoal/10 animate-float">
                                <span class="material-symbols-outlined text-charcoal/40 text-3xl lg:text-4xl">favorite</span>
                            </div>
                            
                            <p class="text-lg lg:text-xl font-serif italic text-charcoal/70 mb-6 lg:mb-8 leading-relaxed lg:leading-loose">
                                "Kaybolan her şey, birilerinin hayatında bir iz bırakır.<br class="hidden lg:block">
                                Bu izleri takip etmek, belki de yeni bir başlangıcın anahtarıdır."
                            </p>
                            
                            <div class="inline-flex items-center gap-3 px-6 py-3 lg:px-8 lg:py-4 bg-gradient-to-r from-charcoal/5 to-primary-accent/5 rounded-full border border-charcoal/10 animate-pulse-glow">
                                <div class="w-2 h-2 lg:w-3 lg:h-3 rounded-full bg-found-green animate-pulse"></div>
                                <span class="text-xs lg:text-sm uppercase tracking-[0.3em] text-charcoal/50 font-medium">
                                    İyilikle Bağlanıyoruz
                                </span>
                                <div class="w-2 h-2 lg:w-3 lg:h-3 rounded-full bg-lost-red animate-pulse delay-300"></div>
                            </div>
                        </div>
                        
                        <!-- İstatistikler -->
                        <div class="grid grid-cols-3 gap-4 lg:gap-8 max-w-md lg:max-w-xl mx-auto mt-12 lg:mt-16">
                            <div class="text-center stat-card bg-white p-4 lg:p-6 rounded-xl shadow-sm">
                                <div class="text-2xl lg:text-4xl font-serif font-light text-charcoal mb-1 lg:mb-2 shimmer-text animate-text-shimmer">150+</div>
                                <div class="text-xs lg:text-sm text-charcoal/40 uppercase tracking-widest">Bulunan</div>
                            </div>
                            <div class="text-center stat-card bg-white p-4 lg:p-6 rounded-xl shadow-sm">
                                <div class="text-2xl lg:text-4xl font-serif font-light text-charcoal mb-1 lg:mb-2">89</div>
                                <div class="text-xs lg:text-sm text-charcoal/40 uppercase tracking-widest">Mutlu An</div>
                            </div>
                            <div class="text-center stat-card bg-white p-4 lg:p-6 rounded-xl shadow-sm">
                                <div class="text-2xl lg:text-4xl font-serif font-light text-charcoal mb-1 lg:mb-2">24/7</div>
                                <div class="text-xs lg:text-sm text-charcoal/40 uppercase tracking-widest">Aktif</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Yol gösterici -->
            <div class="mt-12 lg:mt-16 pt-8 lg:pt-12 border-t border-charcoal/5">
                <div class="flex flex-col lg:flex-row items-center justify-center gap-8 lg:gap-16">
                    <div class="flex items-center gap-3 lg:gap-4">
                        <div class="size-10 lg:size-12 rounded-full bg-lost-red/10 flex items-center justify-center">
                            <span class="material-symbols-outlined text-lost-red text-sm lg:text-base">search</span>
                        </div>
                        <div class="text-left">
                            <div class="text-sm lg:text-base font-medium text-charcoal">Kayıp İlanı Ver</div>
                            <div class="text-xs lg:text-sm text-charcoal/40">Yardım isteyin</div>
                        </div>
                    </div>
                    
                    <div class="hidden lg:block">
                        <span class="material-symbols-outlined text-charcoal/20 text-2xl">arrow_forward</span>
                    </div>
                    <div class="block lg:hidden">
                        <span class="material-symbols-outlined text-charcoal/20">arrow_downward</span>
                    </div>
                    
                    <div class="flex items-center gap-3 lg:gap-4">
                        <div class="size-10 lg:size-12 rounded-full bg-found-green/10 flex items-center justify-center">
                            <span class="material-symbols-outlined text-found-green text-sm lg:text-base">check_circle</span>
                        </div>
                        <div class="text-left">
                            <div class="text-sm lg:text-base font-medium text-charcoal">Bulunanı İşaretle</div>
                            <div class="text-xs lg:text-sm text-charcoal/40">Mutluluğu paylaşın</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Son İlanlar -->
        <div class="px-6 lg:px-12 space-y-8 lg:space-y-12">
            <div class="flex items-end justify-between px-2">
                <h2 class="text-3xl lg:text-4xl font-serif font-light">Son Kayıtlar</h2>
                <button onclick="showPage('explore')" class="text-[10px] lg:text-xs uppercase tracking-widest text-charcoal/40 pb-1 border-b border-charcoal/20 hover:text-charcoal transition">Tümünü Gör</button>
            </div>
            
            <div id="recent-items" class="items-grid">
                <!-- İlanlar buraya yüklenecek -->
                <div class="text-center py-12 col-span-full">
                    <div class="flex flex-col items-center gap-4">
                        <div class="w-12 h-12 border-2 border-charcoal/20 border-t-charcoal rounded-full animate-spin"></div>
                        <p class="text-sm text-charcoal/40">Yükleniyor...</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Keşfet Sayfası -->
    <section id="page-explore" class="hidden px-6 lg:px-12 space-y-12 lg:space-y-16">
        <div class="flex items-end justify-between px-2 pt-8">
            <h2 class="text-3xl lg:text-4xl font-serif font-light">Tüm İlanlar</h2>
            <div class="flex gap-2 lg:gap-3">
                <button onclick="setFilter('all')" id="filter-all" class="px-3 lg:px-4 py-1 lg:py-1.5 text-[10px] lg:text-xs uppercase tracking-widest bg-charcoal text-white rounded">Tümü</button>
                <button onclick="setFilter('lost')" id="filter-lost" class="px-3 lg:px-4 py-1 lg:py-1.5 text-[10px] lg:text-xs uppercase tracking-widest bg-off-white text-lost-red border thin-border rounded">Kayıp</button>
                <button onclick="setFilter('found')" id="filter-found" class="px-3 lg:px-4 py-1 lg:py-1.5 text-[10px] lg:text-xs uppercase tracking-widest bg-off-white text-found-green border thin-border rounded">Bulunan</button>
            </div>
        </div>
        
        <!-- Arama Çubuğu -->
        <div class="search-container">
            <div class="relative">
                <input type="text" id="search-input" placeholder="İlanlarda ara..."
                       class="w-full px-6 py-4 bg-white border thin-border rounded-xl lg:rounded-2xl focus:ring-2 focus:ring-charcoal/30 focus:border-transparent outline-none text-sm lg:text-base pl-12">
                <span class="material-symbols-outlined absolute left-4 top-1/2 transform -translate-y-1/2 text-charcoal/40">
                    search
                </span>
            </div>
        </div>
        
        <div id="explore-items" class="items-grid">
            <!-- İlanlar buraya yüklenecek -->
        </div>
    </section>
    
    <!-- Harita Görünümü -->
    <section id="page-map-view" class="hidden px-4 lg:px-12 space-y-8 lg:space-y-12">
        <div class="flex items-end justify-between px-2 pt-8">
            <h2 class="text-3xl lg:text-4xl font-serif font-light">Harita Görünümü</h2>
            <div class="flex gap-2 lg:gap-3">
                <button onclick="showAllMarkers()" class="px-3 lg:px-4 py-1 lg:py-1.5 text-[10px] lg:text-xs uppercase tracking-widest bg-charcoal text-white rounded">Tümü</button>
                <button onclick="filterMarkers('lost')" class="px-3 lg:px-4 py-1 lg:py-1.5 text-[10px] lg:text-xs uppercase tracking-widest bg-off-white text-lost-red border thin-border rounded">Kayıp</button>
                <button onclick="filterMarkers('found')" class="px-3 lg:px-4 py-1 lg:py-1.5 text-[10px] lg:text-xs uppercase tracking-widest bg-off-white text-found-green border thin-border rounded">Bulunan</button>
            </div>
        </div>
        
        <div class="bg-white rounded-xl lg:rounded-2xl overflow-hidden thin-border shadow-sm">
            <div id="turkey-map" class="w-full"></div>
        </div>
        
        <div id="map-items-list" class="items-grid">
            <!-- Harita öğeleri buraya yüklenecek -->
        </div>
    </section>
    
    <!-- İlan Ekle Sayfası -->
    <section id="page-add" class="hidden">
        <div class="max-w-lg lg:max-w-2xl mx-auto px-6 lg:px-0 py-8 lg:py-12 form-container">
            <div class="mb-8 lg:mb-12">
                <h2 class="text-3xl lg:text-4xl font-serif font-light mb-2">Yeni İlan Oluştur</h2>
                <p class="text-sm lg:text-base text-charcoal/40">Kayıp veya buluntu ilanınızı toplulukla paylaşın</p>
            </div>
            
            <div class="space-y-6 lg:space-y-8">
                <div>
                    <label class="block text-sm lg:text-base font-medium text-charcoal/60 mb-2 lg:mb-3">İlan Türü</label>
                    <div class="grid grid-cols-2 gap-3 lg:gap-4">
                        <button id="type-lost" onclick="setAdType('lost')" class="py-4 lg:py-5 rounded-lg lg:rounded-xl bg-white border thin-border text-lost-red font-medium hover:border-lost-red transition">
                            <span class="flex items-center justify-center gap-2 lg:gap-3">
                                <span class="material-symbols-outlined text-sm lg:text-base">search</span>
                                Kayıp
                            </span>
                        </button>
                        <button id="type-found" onclick="setAdType('found')" class="py-4 lg:py-5 rounded-lg lg:rounded-xl bg-white border thin-border text-charcoal/60 font-medium hover:border-found-green hover:text-found-green transition">
                            <span class="flex items-center justify-center gap-2 lg:gap-3">
                                <span class="material-symbols-outlined text-sm lg:text-base">check_circle</span>
                                Bulundu
                            </span>
                        </button>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm lg:text-base font-medium text-charcoal/60 mb-2 lg:mb-3">Başlık</label>
                    <input type="text" id="add-title" placeholder="Golden Retriever kayıp, Cüzdan bulundu..." 
                           class="w-full px-4 py-3 lg:px-6 lg:py-4 bg-white border thin-border rounded-lg lg:rounded-xl focus:ring-1 focus:ring-charcoal focus:border-transparent outline-none text-sm lg:text-base form-input">
                </div>
                
                <div>
                    <label class="block text-sm lg:text-base font-medium text-charcoal/60 mb-2 lg:mb-3">Açıklama</label>
                    <textarea id="add-desc" rows="4" placeholder="Detaylı açıklama (özellikler, son görüldüğü yer, iletişim bilgileri vb.)..." 
                              class="w-full px-4 py-3 lg:px-6 lg:py-4 bg-white border thin-border rounded-lg lg:rounded-xl focus:ring-1 focus:ring-charcoal focus:border-transparent outline-none text-sm lg:text-base resize-none form-input"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm lg:text-base font-medium text-charcoal/60 mb-2 lg:mb-3">İletişim Numarası</label>
                    <input type="tel" id="add-phone" placeholder="+90 555 123 45 67" 
                           class="w-full px-4 py-3 lg:px-6 lg:py-4 bg-white border thin-border rounded-lg lg:rounded-xl focus:ring-1 focus:ring-charcoal focus:border-transparent outline-none text-sm lg:text-base form-input">
                </div>
                
                <div>
                    <label class="block text-sm lg:text-base font-medium text-charcoal/60 mb-2 lg:mb-3">Konum Seçimi</label>
                    <div class="space-y-4">
                        <button type="button" onclick="openLocationPicker()" id="location-picker-btn" 
                                class="w-full py-3 lg:py-4 bg-charcoal text-white font-medium rounded-lg lg:rounded-xl hover:bg-charcoal/90 transition text-sm lg:text-base flex items-center justify-center gap-2 location-select-btn">
                            <span class="material-symbols-outlined">location_on</span>
                            Konumu Haritadan Seç
                        </button>
                        
                        <div id="selected-location-info" class="hidden selected-location-info">
                            <div class="flex items-start justify-between">
                                <div>
                                    <p class="text-sm font-medium text-charcoal mb-1">Seçilen Konum:</p>
                                    <p id="location-coordinates" class="text-xs text-charcoal/60">Koordinatlar yükleniyor...</p>
                                    <p id="location-address" class="text-xs text-charcoal/40 mt-1">Adres bilgisi alınıyor...</p>
                                </div>
                                <button type="button" onclick="openLocationPicker()" class="text-xs text-found-green hover:underline">
                                    Değiştir
                                </button>
                            </div>
                        </div>
                        
                        <div id="location-map-container" class="hidden">
                            <p class="text-sm text-charcoal/60 mb-2">Haritada istediğiniz yeri tıklayarak konum seçin:</p>
                            <div id="location-map" class="location-map"></div>
                            <div class="flex gap-3 mt-3">
                                <button type="button" onclick="confirmLocation()" class="flex-1 py-2 bg-found-green text-white text-sm rounded-lg hover:bg-found-green/90">
                                    Konumu Onayla
                                </button>
                                <button type="button" onclick="cancelLocationPicker()" class="flex-1 py-2 bg-lost-red text-white text-sm rounded-lg hover:bg-lost-red/90">
                                    İptal
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm lg:text-base font-medium text-charcoal/60 mb-2 lg:mb-3">Fotoğraf</label>
                    <div onclick="document.getElementById('file-input').click()" class="border-2 border-dashed border-charcoal/10 rounded-lg lg:rounded-xl p-8 lg:p-12 text-center cursor-pointer hover:border-charcoal/20 transition bg-white">
                        <div class="w-12 h-12 lg:w-16 lg:h-16 mx-auto mb-3 lg:mb-4 bg-charcoal/5 rounded-full flex items-center justify-center">
                            <span class="material-symbols-outlined text-charcoal/40 text-xl lg:text-2xl">photo_camera</span>
                        </div>
                        <p class="text-sm lg:text-base text-charcoal/60">Fotoğraf yüklemek için tıklayın</p>
                        <p class="text-xs lg:text-sm text-charcoal/40 mt-1 lg:mt-2">PNG, JPG (Maks. 5MB)</p>
                        <input type="file" id="file-input" class="hidden" accept="image/*">
                    </div>
                    <div id="image-preview" class="mt-4 lg:mt-6 hidden">
                        <img id="preview-img" class="w-full max-h-64 lg:max-h-80 object-contain rounded-lg lg:rounded-xl thin-border">
                    </div>
                </div>
                
                <button onclick="saveAd()" id="save-btn" 
                        class="w-full py-3 lg:py-4 bg-charcoal text-white font-medium rounded-lg lg:rounded-xl hover:bg-charcoal/90 transition text-sm lg:text-base form-button">
                    <span id="save-btn-text">İlanı Yayınla</span>
                </button>
            </div>
        </div>
    </section>
    
    <!-- Profil Sayfası -->
    <section id="page-profile" class="hidden">
        <div id="profile-content" class="max-w-4xl lg:max-w-6xl mx-auto px-6 lg:px-0 py-8 lg:py-12">
            <!-- Profil içeriği buraya yüklenecek -->
        </div>
    </section>
</main>

<!-- Alt Navigasyon -->
<nav class="fixed bottom-0 left-0 right-0 z-50 px-6 pb-6 pt-4 bottom-nav-blur bg-gradient-to-t from-off-white via-off-white/95 to-transparent">
    <div class="flex items-center justify-around h-16 lg:h-20 bg-charcoal rounded-full px-6 lg:px-8 shadow-2xl">
        <button data-page="home" class="text-off-white hover:text-off-white/80 transition-colors nav-button">
            <span class="material-symbols-outlined font-extralight text-2xl lg:text-3xl">home</span>
        </button>
        <button data-page="map-view" class="text-off-white/60 hover:text-off-white transition-colors nav-button">
            <span class="material-symbols-outlined font-extralight text-2xl lg:text-3xl">location_on</span>
        </button>
        <button data-page="add" class="relative -top-12 size-16 lg:size-20 bg-primary-accent rounded-full flex items-center justify-center text-white shadow-xl ring-8 ring-off-white/10 hover:scale-105 transition nav-button">
            <span class="material-symbols-outlined text-3xl lg:text-4xl font-extralight">add</span>
        </button>
        <button data-page="explore" class="text-off-white/60 hover:text-off-white transition-colors nav-button">
            <span class="material-symbols-outlined font-extralight text-2xl lg:text-3xl">explore</span>
        </button>
        <button data-page="profile" class="text-off-white/60 hover:text-off-white transition-colors nav-button">
            <span class="material-symbols-outlined font-extralight text-2xl lg:text-3xl">account_circle</span>
        </button>
    </div>
</nav>

<!-- Konum Seçme Modalı -->
<div id="location-modal" class="fixed inset-0 z-[9998] flex items-center justify-center p-4 bg-black/60 fade-in hidden">
    <div class="bg-white rounded-2xl overflow-hidden shadow-2xl slide-up w-full max-w-4xl max-h-[90vh] overflow-y-auto">
        <div class="p-6 lg:p-8">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-2xl lg:text-3xl font-serif font-light">Konum Seç</h2>
                <button onclick="closeLocationModal()" class="p-2 hover:bg-charcoal/5 rounded-lg transition">
                    <span class="material-symbols-outlined text-charcoal/60">close</span>
                </button>
            </div>
            
            <div class="mb-4">
                <p class="text-sm text-charcoal/60 mb-2">Haritada kaybolan/bulunan eşyanın konumunu seçin:</p>
                <div class="flex items-center gap-2 text-xs text-charcoal/40">
                    <span class="material-symbols-outlined text-sm">info</span>
                    İstediğiniz yeri tıklayın veya haritayı kaydırarak konumu bulun
                </div>
            </div>
            
            <div id="location-modal-map" class="h-96 lg:h-[500px] rounded-xl overflow-hidden thin-border"></div>
            
            <div class="mt-6 p-4 bg-off-white rounded-lg">
                <div class="flex items-center justify-between mb-3">
                    <div>
                        <p class="font-medium text-charcoal">Seçilen Konum:</p>
                        <p id="modal-location-coords" class="text-sm text-charcoal/60">Koordinatlar: -</p>
                        <p id="modal-location-address" class="text-xs text-charcoal/40">Adres: Konum seçilmedi</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="getUserLocation()" class="px-3 py-2 bg-charcoal text-white text-xs rounded-lg hover:bg-charcoal/90 flex items-center gap-1">
                            <span class="material-symbols-outlined text-sm">my_location</span>
                            Mevcut Konum
                        </button>
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="saveSelectedLocation()" id="confirm-location-btn" disabled
                            class="flex-1 py-3 bg-found-green text-white font-medium rounded-lg hover:bg-found-green/90 transition disabled:opacity-50 disabled:cursor-not-allowed">
                        Konumu Onayla
                    </button>
                    <button onclick="closeLocationModal()" 
                            class="flex-1 py-3 bg-lost-red text-white font-medium rounded-lg hover:bg-lost-red/90 transition">
                        İptal
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Firebase and App Logic -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, update, get, remove, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBB_cc3y2r8qvZQx1wwmNyhqu6joYumj3Q",
        authDomain: "ekopsim.firebaseapp.com",
        databaseURL: "https://ekopsim-default-rtdb.firebaseio.com",
        projectId: "ekopsim",
        storageBucket: "ekopsim.firebasestorage.app",
        messagingSenderId: "488553599548",
        appId: "1:488553599548:web:cbbf5ec6ab5f3ca1912939"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let currentUser = null;
    let currentFilter = 'all';
    let adType = 'lost';
    let turkeyMap = null;
    let locationMap = null;
    let markers = [];
    let selectedImage = null;
    let isLoading = false;
    let currentPopup = null;
    
    // Yeni değişkenler: Konum seçimi için
    let selectedLat = null;
    let selectedLng = null;
    let selectedAddress = "Konum seçilmedi";
    let locationMarker = null;
    
    // Arama değişkeni
    let searchTerm = '';
    let allItems = [];

    // --- Loading Overlay ---
    function showLoading() {
        if (!isLoading) {
            isLoading = true;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
    }

    function hideLoading() {
        isLoading = false;
        document.getElementById('loading-overlay').classList.add('hidden');
    }

    // --- Floating Dots Animation ---
    function createFloatingDots() {
        const container = document.getElementById('floating-dots');
        if (!container) return;
        
        container.innerHTML = '';
        
        const dotCount = window.innerWidth > 1024 ? 25 : 15;
        
        for (let i = 0; i < dotCount; i++) {
            const dot = document.createElement('div');
            dot.className = 'floating-dot';
            
            const size = Math.random() * (window.innerWidth > 1024 ? 8 : 6) + 2;
            const posX = Math.random() * 100;
            const posY = Math.random() * 100;
            const delay = Math.random() * 5;
            const duration = Math.random() * (window.innerWidth > 1024 ? 15 : 10) + 10;
            
            dot.style.width = `${size}px`;
            dot.style.height = `${size}px`;
            dot.style.left = `${posX}%`;
            dot.style.top = `${posY}%`;
            dot.style.animation = `float ${duration}s ease-in-out ${delay}s infinite`;
            dot.style.opacity = Math.random() * 0.2 + 0.05;
            
            container.appendChild(dot);
        }
    }

    // --- Bottom Navigation Setup ---
    function setupBottomNavigation() {
        const navButtons = document.querySelectorAll('nav button[data-page]');
        navButtons.forEach(button => {
            button.addEventListener('click', function() {
                const page = this.getAttribute('data-page');
                if (page) {
                    showPage(page);
                }
            });
        });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        setupBottomNavigation();
        showPage('home');
        setAdType('lost');
        setFilter('all');
        createFloatingDots();
        
        // Arama input event listener
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                searchTerm = this.value.toLowerCase();
                loadExploreItems();
            });
        }
        
        if (window.innerWidth > 1024) {
            document.body.classList.add('text-lg');
        }
        
        window.addEventListener('resize', createFloatingDots);
    });

    // --- Konum Seçme Fonksiyonları ---
    window.openLocationPicker = () => {
        document.getElementById('location-modal').classList.remove('hidden');
        initLocationMap();
    };

    window.closeLocationModal = () => {
        document.getElementById('location-modal').classList.add('hidden');
        if (locationMap) {
            locationMap.remove();
            locationMap = null;
            locationMarker = null;
        }
    };

    function initLocationMap() {
        if (!locationMap) {
            const mapElement = document.getElementById('location-modal-map');
            if (!mapElement) return;
            
            // Önceki haritayı temizle
            mapElement.innerHTML = '';
            
            // Varsayılan konum: İstanbul
            const defaultLat = selectedLat || 41.0082;
            const defaultLng = selectedLng || 28.9784;
            
            locationMap = L.map('location-modal-map').setView([defaultLat, defaultLng], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                minZoom: 6,
                maxZoom: 18
            }).addTo(locationMap);
            
            // Türkiye sınırlarını kısıtla
            locationMap.setMaxBounds([
                [35.8, 25.6],
                [42.1, 44.8]
            ]);
            
            // Eğer daha önce seçilmiş konum varsa marker ekle
            if (selectedLat && selectedLng) {
                addLocationMarker(selectedLat, selectedLng);
                updateLocationInfo(selectedLat, selectedLng);
                document.getElementById('confirm-location-btn').disabled = false;
            }
            
            // Haritaya tıklanınca konum seç
            locationMap.on('click', (e) => {
                addLocationMarker(e.latlng.lat, e.latlng.lng);
                updateLocationInfo(e.latlng.lat, e.latlng.lng);
                getAddressFromCoordinates(e.latlng.lat, e.latlng.lng);
                document.getElementById('confirm-location-btn').disabled = false;
            });
            
            setTimeout(() => {
                locationMap.invalidateSize();
            }, 100);
        }
    }

    function addLocationMarker(lat, lng) {
        // Önceki marker'ı temizle
        if (locationMarker) {
            locationMap.removeLayer(locationMarker);
        }
        
        // Yeni marker ekle
        locationMarker = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'custom-location-marker',
                html: `<div class="location-marker">
                         <div style="width: 100%; height: 100%; border-radius: 50%; background-color: #dc2626; display: flex; align-items: center; justify-content: center;">
                           <span class="material-symbols-outlined" style="color: white; font-size: 12px;">
                             location_on
                           </span>
                         </div>
                       </div>`,
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            })
        }).addTo(locationMap);
        
        // Haritayı seçilen konuma kaydır
        locationMap.setView([lat, lng], 13);
        
        // Seçilen koordinatları kaydet
        selectedLat = lat;
        selectedLng = lng;
    }

    function updateLocationInfo(lat, lng) {
        document.getElementById('modal-location-coords').textContent = 
            `Koordinatlar: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    }

    async function getAddressFromCoordinates(lat, lng) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
            const data = await response.json();
            
            if (data && data.address) {
                const addressParts = [];
                
                if (data.address.road) addressParts.push(data.address.road);
                if (data.address.neighbourhood) addressParts.push(data.address.neighbourhood);
                if (data.address.suburb) addressParts.push(data.address.suburb);
                if (data.address.city) addressParts.push(data.address.city);
                if (data.address.county) addressParts.push(data.address.county);
                
                selectedAddress = addressParts.join(', ') || 'Adres bilgisi alınamadı';
            } else {
                selectedAddress = 'Adres bilgisi alınamadı';
            }
            
            document.getElementById('modal-location-address').textContent = `Adres: ${selectedAddress}`;
        } catch (error) {
            console.error('Adres alınamadı:', error);
            selectedAddress = 'Adres alınamadı';
            document.getElementById('modal-location-address').textContent = `Adres: ${selectedAddress}`;
        }
    }

    window.getUserLocation = () => {
        if (navigator.geolocation) {
            showLoading();
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Türkiye sınırları içinde mi kontrol et
                    if (lat >= 35.8 && lat <= 42.1 && lng >= 25.6 && lng <= 44.8) {
                        addLocationMarker(lat, lng);
                        updateLocationInfo(lat, lng);
                        getAddressFromCoordinates(lat, lng);
                        document.getElementById('confirm-location-btn').disabled = false;
                    } else {
                        alert('Lütfen Türkiye sınırları içinde bir konum seçin.');
                        addLocationMarker(41.0082, 28.9784); // İstanbul'a dön
                        updateLocationInfo(41.0082, 28.9784);
                        getAddressFromCoordinates(41.0082, 28.9784);
                    }
                    hideLoading();
                },
                (error) => {
                    console.error('Konum alınamadı:', error);
                    alert('Konumunuz alınamadı. Lütfen haritadan konum seçin.');
                    hideLoading();
                }
            );
        } else {
            alert('Tarayıcınız konum servisini desteklemiyor. Lütfen haritadan konum seçin.');
        }
    };

    window.saveSelectedLocation = () => {
        if (selectedLat && selectedLng) {
            // Formda göster
            document.getElementById('selected-location-info').classList.remove('hidden');
            document.getElementById('location-coordinates').textContent = 
                `Koordinatlar: ${selectedLat.toFixed(6)}, ${selectedLng.toFixed(6)}`;
            document.getElementById('location-address').textContent = `Adres: ${selectedAddress}`;
            
            // Butonu güncelle
            const btn = document.getElementById('location-picker-btn');
            btn.innerHTML = `
                <span class="material-symbols-outlined">check_circle</span>
                Konum Seçildi
            `;
            btn.classList.add('active');
            
            closeLocationModal();
        }
    };

    // --- Authentication ---
    window.toggleAuthMode = () => {
        const title = document.getElementById('auth-title');
        const btn = document.getElementById('auth-btn-text');
        const toggle = document.getElementById('auth-toggle');
        
        if (title.textContent === "Giriş Yap") {
            title.textContent = "Kayıt Ol";
            btn.textContent = "KAYIT OL";
            toggle.innerHTML = 'Zaten hesabınız var mı? <span class="underline">Giriş Yap</span>';
        } else {
            title.textContent = "Giriş Yap";
            btn.textContent = "GİRİŞ YAP";
            toggle.innerHTML = 'Hesabınız yok mu? <span class="underline">Kayıt Ol</span>';
        }
    };

    window.handleAuth = async () => {
        const email = document.getElementById('auth-email').value.trim();
        const pass = document.getElementById('auth-pass').value;
        
        if (!email || !pass) {
            alert("Lütfen tüm alanları doldurun.");
            return;
        }
        
        const btn = document.getElementById('auth-btn');
        const btnText = document.getElementById('auth-btn-text');
        const originalText = btnText.textContent;
        btnText.textContent = "İşleniyor...";
        btn.disabled = true;
        
        showLoading();
        
        try {
            if (originalText === "KAYIT OL") {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                await set(ref(db, `users/${cred.user.uid}`), {
                    name: email.split('@')[0],
                    email: email,
                    bio: "",
                    phone: "",
                    contact: "",
                    profileImage: "",
                    createdAt: new Date().toISOString()
                });
                alert("🎉 Kayıt başarılı! Topluluğumuza hoş geldiniz.");
            } else {
                await signInWithEmailAndPassword(auth, email, pass);
            }
        } catch (error) {
            alert("Hata: " + error.message);
        } finally {
            hideLoading();
            btnText.textContent = originalText;
            btn.disabled = false;
        }
    };

    window.logout = async () => {
        if (confirm("Çıkış yapmak istediğinize emin misiniz?")) {
            showLoading();
            try {
                await signOut(auth);
                showPage('home');
                document.getElementById('auth-modal').classList.remove('hidden');
            } catch (error) {
                console.error("Çıkış hatası:", error);
                alert("Çıkış yapılırken bir hata oluştu.");
            } finally {
                hideLoading();
            }
        }
    };

    // --- Page Management ---
    window.showPage = (pageId) => {
        if (isLoading) return;
        
        showLoading();
        
        closeDetailModal();
        closeLocationModal();
        closeProfileEditModal();
        
        if (currentPopup && turkeyMap) {
            turkeyMap.closePopup(currentPopup);
            currentPopup = null;
        }
        
        document.querySelectorAll('main > section').forEach(section => {
            section.classList.add('hidden');
        });
        
        const pageElement = document.getElementById(`page-${pageId}`);
        if (pageElement) {
            pageElement.classList.remove('hidden');
            
            if (pageId === 'home') {
                setTimeout(() => {
                    createFloatingDots();
                }, 100);
            }
            
            // İlan ekleme sayfasına geçtiğimizde konum seçimini sıfırla
            if (pageId === 'add') {
                resetLocationSelection();
            }
        } else {
            if (pageId === 'profile') {
                const container = document.getElementById('page-profile');
                container.classList.remove('hidden');
            }
        }
        
        setTimeout(() => {
            try {
                switch(pageId) {
                    case 'home':
                        loadRecentItems();
                        break;
                    case 'explore':
                        loadExploreItems();
                        break;
                    case 'map-view':
                        initTurkeyMap();
                        loadMapItems();
                        break;
                    case 'profile':
                        if (currentUser) {
                            loadProfilePage();
                        } else {
                            showPage('home');
                            document.getElementById('auth-modal').classList.remove('hidden');
                        }
                        break;
                }
            } catch (error) {
                console.error(`Sayfa yükleme hatası (${pageId}):`, error);
                alert("Sayfa yüklenirken bir hata oluştu.");
            } finally {
                hideLoading();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }, 300);
    };

    function resetLocationSelection() {
        selectedLat = null;
        selectedLng = null;
        selectedAddress = "Konum seçilmedi";
        
        document.getElementById('selected-location-info').classList.add('hidden');
        const btn = document.getElementById('location-picker-btn');
        btn.innerHTML = `
            <span class="material-symbols-outlined">location_on</span>
            Konumu Haritadan Seç
        `;
        btn.classList.remove('active');
    }

    // --- Map Management ---
    function initTurkeyMap() {
        const mapElement = document.getElementById('turkey-map');
        if (!mapElement) return;
        
        if (!turkeyMap) {
            const mapHeight = window.innerWidth > 1024 ? '500px' : 
                            window.innerWidth > 1536 ? '600px' : '400px';
            mapElement.style.height = mapHeight;
            
            turkeyMap = L.map('turkey-map').setView([39.0, 35.0], 6);
            
            turkeyMap.setMaxBounds([
                [35.8, 25.6],
                [42.1, 44.8]
            ]);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                minZoom: 6,
                maxZoom: 12
            }).addTo(turkeyMap);
            
            turkeyMap.on('click', (e) => {
                if (currentPopup && turkeyMap) {
                    turkeyMap.closePopup(currentPopup);
                    currentPopup = null;
                }
            });
            
            turkeyMap.on('popupopen', (e) => {
                currentPopup = e.popup;
            });
            
            turkeyMap.on('popupclose', () => {
                currentPopup = null;
            });
        }
        
        setTimeout(() => {
            turkeyMap.invalidateSize();
        }, 100);
    }

    window.showAllMarkers = () => {
        clearMarkers();
        loadMapItems();
    };

    window.filterMarkers = (type) => {
        clearMarkers();
        loadMapItems(type);
    };

    function clearMarkers() {
        markers.forEach(marker => {
            if (turkeyMap && marker) {
                turkeyMap.removeLayer(marker);
            }
        });
        markers = [];
    }

    function loadMapItems(filterType = 'all') {
        const container = document.getElementById('map-items-list');
        container.innerHTML = '<div class="col-span-full text-center py-12"><div class="animate-spin w-8 h-8 border-2 border-charcoal/20 border-t-charcoal rounded-full mx-auto"></div></div>';
        
        onValue(ref(db, 'items'), (snapshot) => {
            const items = [];
            snapshot.forEach((child) => {
                const item = child.val();
                if (filterType === 'all' || item.type === filterType) {
                    items.push(item);
                }
            });
            
            clearMarkers();
            
            items.forEach(item => {
                if (item.lat && item.lng) {
                    const markerColor = item.type === 'lost' ? '#dc2626' : '#059669';
                    const iconColor = item.userId === currentUser?.uid ? '#8e8d8a' : markerColor;
                    
                    const markerIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background-color: ${iconColor}; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                 <span class="material-symbols-outlined" style="color: white; font-size: 16px;">
                                     ${item.type === 'lost' ? 'search' : 'check'}
                                 </span>
                               </div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });
                    
                    const mapMarker = L.marker([item.lat, item.lng], { icon: markerIcon }).addTo(turkeyMap);
                    
                    const popupContent = `
                        <div style="min-width: 250px; padding: 16px; font-family: 'Inter', sans-serif;">
                            <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px;">
                                <div style="width: 60px; height: 60px; border-radius: 8px; overflow: hidden; flex-shrink: 0;">
                                    <img src="${item.image}" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <div>
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                        <div style="width: 8px; height: 8px; border-radius: 50%; background-color: ${item.type === 'lost' ? '#dc2626' : '#059669'}"></div>
                                        <strong style="font-size: 14px; font-weight: 600;">${item.title}</strong>
                                    </div>
                                    <p style="font-size: 12px; color: #666; margin-bottom: 8px; line-height: 1.4;">
                                        ${item.description.substring(0, 80)}${item.description.length > 80 ? '...' : ''}
                                    </p>
                                </div>
                            </div>
                            <button onclick="window.handleMapPopupDetail('${item.id}')" style="width: 100%; padding: 8px 16px; background: #1a1a1a; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 500; transition: background 0.2s;" 
                                    onmouseover="this.style.backgroundColor='#333'"
                                    onmouseout="this.style.backgroundColor='#1a1a1a'">
                                Detayları Gör
                            </button>
                        </div>
                    `;
                    
                    const popup = L.popup({
                        className: 'custom-popup',
                        closeButton: true,
                        autoClose: false,
                        closeOnClick: false,
                        maxWidth: 300
                    }).setContent(popupContent);
                    
                    mapMarker.bindPopup(popup);
                    
                    markers.push(mapMarker);
                }
            });
            
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                turkeyMap.fitBounds(group.getBounds().pad(0.1));
            } else {
                turkeyMap.setView([39.0, 35.0], 6);
            }
            
            const itemsToShow = window.innerWidth > 1536 ? 8 : window.innerWidth > 1024 ? 6 : 4;
            displayItems(items.slice(0, itemsToShow), container, true);
            
        }, (error) => {
            console.error("Harita verisi yükleme hatası:", error);
            container.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <div class="w-12 h-12 bg-charcoal/5 rounded-full flex items-center justify-center mx-auto mb-3">
                        <span class="material-symbols-outlined text-charcoal/40">error</span>
                    </div>
                    <p class="text-sm text-charcoal/40">Harita verileri yüklenirken bir hata oluştu.</p>
                </div>
            `;
        });
    }

    window.handleMapPopupDetail = (itemId) => {
        if (currentPopup && turkeyMap) {
            turkeyMap.closePopup(currentPopup);
            currentPopup = null;
        }
        showItemDetailPopup(itemId);
    };

    // --- Item Management ---
    window.setAdType = (type) => {
        adType = type;
        const lostBtn = document.getElementById('type-lost');
        const foundBtn = document.getElementById('type-found');
        
        if (type === 'lost') {
            lostBtn.classList.add('border-lost-red', 'text-lost-red');
            lostBtn.classList.remove('text-charcoal/60');
            
            foundBtn.classList.remove('border-found-green', 'text-found-green', 'hover:border-found-green', 'hover:text-found-green');
            foundBtn.classList.add('border', 'thin-border', 'text-charcoal/60');
        } else {
            foundBtn.classList.add('border-found-green', 'text-found-green', 'hover:border-found-green', 'hover:text-found-green');
            foundBtn.classList.remove('text-charcoal/60');
            
            lostBtn.classList.remove('border-lost-red', 'text-lost-red');
            lostBtn.classList.add('border', 'thin-border', 'text-charcoal/60');
        }
    };

    // Image upload handling
    document.getElementById('file-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        if (file.size > 5 * 1024 * 1024) {
            alert("Dosya boyutu 5MB'tan küçük olmalıdır.");
            return;
        }
        
        selectedImage = file;
        const reader = new FileReader();
        reader.onload = (event) => {
            const preview = document.getElementById('preview-img');
            preview.src = event.target.result;
            document.getElementById('image-preview').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    });

    window.saveAd = async () => {
        if (!currentUser) {
            alert("Lütfen önce giriş yapın.");
            showPage('home');
            document.getElementById('auth-modal').classList.remove('hidden');
            return;
        }
        
        const title = document.getElementById('add-title').value.trim();
        const desc = document.getElementById('add-desc').value.trim();
        const phone = document.getElementById('add-phone').value.trim();
        
        if (!title) {
            alert("Lütfen başlık girin.");
            return;
        }
        
        if (!selectedImage) {
            alert("Lütfen bir fotoğraf yükleyin.");
            return;
        }
        
        if (!phone) {
            alert("Lütfen iletişim numarası girin.");
            return;
        }
        
        // Konum kontrolü
        if (!selectedLat || !selectedLng) {
            const confirmNoLocation = confirm("Konum seçmediniz. Rastgele bir Türkiye konumu atansın mı? (Önerilmez)\n\nHaritadan konum seçmek için 'İptal' diyip konum seçebilirsiniz.");
            if (!confirmNoLocation) {
                openLocationPicker();
                return;
            }
            // Rastgele Türkiye konumu
            selectedLat = 39.0 + (Math.random() - 0.5) * 2;
            selectedLng = 35.0 + (Math.random() - 0.5) * 3;
        }
        
        const btn = document.getElementById('save-btn');
        const btnText = document.getElementById('save-btn-text');
        const originalText = btnText.textContent;
        btnText.textContent = "Yükleniyor...";
        btn.disabled = true;
        
        showLoading();
        
        try {
            const reader = new FileReader();
            reader.onload = async (event) => {
                const base64Image = event.target.result;
                
                const newItemRef = push(ref(db, 'items'));
                await set(newItemRef, {
                    id: newItemRef.key,
                    title,
                    description: desc,
                    phone,
                    type: adType,
                    image: base64Image,
                    lat: selectedLat,
                    lng: selectedLng,
                    address: selectedAddress,
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    userName: currentUser.displayName || currentUser.email.split('@')[0],
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
                
                // Formu sıfırla
                document.getElementById('add-title').value = '';
                document.getElementById('add-desc').value = '';
                document.getElementById('add-phone').value = '';
                document.getElementById('image-preview').classList.add('hidden');
                selectedImage = null;
                document.getElementById('file-input').value = '';
                resetLocationSelection();
                
                alert("🎉 İlan başarıyla yayınlandı!");
                showPage('home');
                
                btnText.textContent = originalText;
                btn.disabled = false;
                hideLoading();
            };
            reader.readAsDataURL(selectedImage);
            
        } catch (error) {
            console.error("İlan kaydetme hatası:", error);
            alert("İlan kaydedilirken bir hata oluştu.");
            btnText.textContent = originalText;
            btn.disabled = false;
            hideLoading();
        }
    };

    // --- Item Display ---
    function loadRecentItems() {
        const container = document.getElementById('recent-items');
        container.innerHTML = '<div class="col-span-full text-center py-12"><div class="animate-spin w-8 h-8 border-2 border-charcoal/20 border-t-charcoal rounded-full mx-auto"></div></div>';
        
        onValue(ref(db, 'items'), (snapshot) => {
            allItems = [];
            snapshot.forEach((child) => {
                const item = child.val();
                allItems.push(item);
            });
            
            allItems.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            const recentCount = window.innerWidth > 1536 ? 4 : window.innerWidth > 1024 ? 3 : 3;
            const recentItems = allItems.slice(0, recentCount);
            
            displayItems(recentItems, container);
        }, (error) => {
            console.error("Veri yükleme hatası:", error);
            container.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <div class="w-12 h-12 bg-charcoal/5 rounded-full flex items-center justify-center mx-auto mb-3">
                        <span class="material-symbols-outlined text-charcoal/40">error</span>
                    </div>
                    <p class="text-sm text-charcoal/40">İlanlar yüklenirken bir hata oluştu.</p>
                </div>
            `;
        });
    }

    window.loadExploreItems = () => {
        const container = document.getElementById('explore-items');
        container.innerHTML = '<div class="col-span-full text-center py-12"><div class="animate-spin w-8 h-8 border-2 border-charcoal/20 border-t-charcoal rounded-full mx-auto"></div></div>';
        
        onValue(ref(db, 'items'), (snapshot) => {
            allItems = [];
            snapshot.forEach((child) => {
                const item = child.val();
                allItems.push(item);
            });
            
            allItems.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // Filtreleme
            let filteredItems = allItems;
            
            if (currentFilter !== 'all') {
                filteredItems = filteredItems.filter(item => item.type === currentFilter);
            }
            
            // Arama filtresi
            if (searchTerm) {
                filteredItems = filteredItems.filter(item => 
                    item.title.toLowerCase().includes(searchTerm) ||
                    item.description.toLowerCase().includes(searchTerm)
                );
            }
            
            displayItems(filteredItems, container);
        });
    };

    function displayItems(items, container, fromMap = false) {
        if (items.length === 0) {
            container.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <div class="w-12 h-12 bg-charcoal/5 rounded-full flex items-center justify-center mx-auto mb-3">
                        <span class="material-symbols-outlined text-charcoal/40">search_off</span>
                    </div>
                    <p class="text-sm text-charcoal/40">${searchTerm ? 'Aramanızla eşleşen ilan bulunamadı.' : 'Henüz ilan bulunmuyor.'}</p>
                    <button onclick="showPage('add')" class="mt-3 px-4 py-1.5 bg-charcoal text-white text-xs rounded-lg">
                        İlk İlanı Sen Ver
                    </button>
                </div>
            `;
            return;
        }
        
        container.innerHTML = items.map(item => `
            <div class="group cursor-pointer item-card" onclick="showItemDetailPopup('${item.id}')">
                <div class="relative aspect-[4/5] overflow-hidden thin-border bg-white">
                    <img src="${item.image}" alt="${item.title}" class="h-full w-full object-cover grayscale-[0.3] group-hover:scale-[1.02] transition-transform duration-700">
                    <div class="absolute top-6 left-6">
                        <span class="px-3 py-1 bg-white/90 backdrop-blur-sm text-[10px] lg:text-xs uppercase tracking-[0.2em] font-medium ${item.type === 'lost' ? 'text-lost-red' : 'text-found-green'}">
                            ${item.type === 'lost' ? 'Kayıp' : 'Bulundu'}
                        </span>
                    </div>
                    ${fromMap ? `<div class="absolute bottom-6 right-6">
                        <button onclick="event.stopPropagation(); showItemDetailPopup('${item.id}')" class="size-8 lg:size-10 bg-charcoal/80 backdrop-blur-sm rounded-full flex items-center justify-center text-white hover:bg-charcoal transition">
                            <span class="material-symbols-outlined text-sm lg:text-base">visibility</span>
                        </button>
                    </div>` : ''}
                </div>
                <div class="mt-6 flex justify-between items-start">
                    <div class="flex-1">
                        <h3 class="text-xl lg:text-2xl font-serif font-light italic line-clamp-1">${item.title}</h3>
                        <p class="text-[11px] lg:text-xs text-charcoal/40 uppercase tracking-widest mt-1">
                            ${item.phone ? '📞 ' + item.phone : 'İletişim yok'}
                        </p>
                        <p class="text-xs lg:text-sm text-charcoal/30 mt-2 line-clamp-2">${item.description || 'Açıklama yok'}</p>
                    </div>
                    <span class="text-[10px] lg:text-xs text-charcoal/30 ml-2 flex-shrink-0">${formatDate(item.createdAt)}</span>
                </div>
            </div>
        `).join('');
    }

    // --- Item Detail Popup ---
    window.showItemDetailPopup = async (itemId) => {
        if (currentPopup && turkeyMap) {
            turkeyMap.closePopup(currentPopup);
            currentPopup = null;
        }
        
        showLoading();
        try {
            const snapshot = await get(ref(db, `items/${itemId}`));
            if (!snapshot.exists()) {
                alert("İlan bulunamadı.");
                hideLoading();
                return;
            }
            
            const item = snapshot.val();
            
            const detailModal = document.getElementById('detail-modal');
            const detailContent = detailModal.querySelector('.detail-popup');
            
            detailContent.innerHTML = `
                <div class="p-6 lg:p-8">
                    <div class="flex items-start justify-between mb-6 lg:mb-8">
                        <div>
                            <h2 class="text-2xl lg:text-3xl font-serif font-light italic mb-2">${item.title}</h2>
                            <div class="flex items-center gap-3">
                                <span class="px-3 py-1 ${item.type === 'lost' ? 'bg-lost-red/10 text-lost-red' : 'bg-found-green/10 text-found-green'} text-xs lg:text-sm uppercase tracking-widest rounded">
                                    ${item.type === 'lost' ? 'Kayıp' : 'Bulundu'}
                                </span>
                                <span class="text-sm lg:text-base text-charcoal/40">${formatDate(item.createdAt)}</span>
                            </div>
                        </div>
                        <button onclick="closeDetailModal()" class="p-2 hover:bg-charcoal/5 rounded-lg transition">
                            <span class="material-symbols-outlined text-charcoal/60 text-xl lg:text-2xl">close</span>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 lg:gap-8 mb-6 lg:mb-8">
                        <div>
                            <div class="aspect-square overflow-hidden rounded-xl lg:rounded-2xl thin-border bg-white mb-4 lg:mb-6">
                                <img src="${item.image}" alt="${item.title}" class="w-full h-full object-cover">
                            </div>
                            <div class="flex items-center gap-3 lg:gap-4 p-3 lg:p-4 bg-off-white rounded-lg lg:rounded-xl cursor-pointer" onclick="showProfile('${item.userId}')">
                                <div class="size-10 lg:size-12 rounded-full bg-charcoal/5 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-charcoal/60 text-lg lg:text-xl">person</span>
                                </div>
                                <div>
                                    <p class="text-sm lg:text-base font-medium">${item.userName || 'Kullanıcı'}</p>
                                    <p class="text-xs lg:text-sm text-charcoal/40">${item.userEmail || ''}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="mb-4 lg:mb-6">
                                <h3 class="font-medium text-charcoal/60 mb-2 lg:mb-3 text-sm lg:text-base uppercase tracking-widest">Açıklama</h3>
                                <p class="text-charcoal whitespace-pre-line leading-relaxed text-sm lg:text-base">${item.description || 'Açıklama yok'}</p>
                            </div>
                            
                            <div class="mb-4 lg:mb-6">
                                <h3 class="font-medium text-charcoal/60 mb-2 lg:mb-3 text-sm lg:text-base uppercase tracking-widest">İletişim</h3>
                                <div class="flex items-center gap-2 lg:gap-3 p-3 lg:p-4 bg-off-white rounded-lg lg:rounded-xl">
                                    <span class="material-symbols-outlined">call</span>
                                    <span class="font-medium text-sm lg:text-base">${item.phone || 'İletişim numarası yok'}</span>
                                </div>
                            </div>
                            
                            <div>
                                <h3 class="font-medium text-charcoal/60 mb-2 lg:mb-3 text-sm lg:text-base uppercase tracking-widest">Konum</h3>
                                <div id="detail-map-mini" class="map-mini bg-charcoal/5"></div>
                                <p class="text-xs lg:text-sm text-charcoal/40 mt-2">
                                    📍 ${item.address || `Koordinatlar: ${item.lat?.toFixed(4) || '0'}, ${item.lng?.toFixed(4) || '0'}`}
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    ${currentUser && item.userId === currentUser.uid && item.type === 'lost' ? `
                        <div class="pt-6 border-t thin-border flex gap-3 lg:gap-4">
                            <button onclick="markAsFound('${itemId}')" 
                                    class="flex-1 py-3 lg:py-4 bg-found-green text-white font-medium rounded-lg lg:rounded-xl hover:bg-found-green/90 transition text-sm lg:text-base">
                                ✅ Bulundu Olarak İşaretle
                            </button>
                            <button onclick="deleteItem('${itemId}')" 
                                    class="flex-1 py-3 lg:py-4 bg-lost-red text-white font-medium rounded-lg lg:rounded-xl hover:bg-lost-red/90 transition text-sm lg:text-base">
                                🗑️ İlanı Sil
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
            
            detailModal.classList.remove('hidden');
            
            setTimeout(() => {
                const miniMap = L.map('detail-map-mini').setView([item.lat || 39.0, item.lng || 35.0], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(miniMap);
                
                const miniMarker = L.marker([item.lat || 39.0, item.lng || 35.0], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background-color: ${item.type === 'lost' ? '#dc2626' : '#059669'}; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center;">
                                 <span class="material-symbols-outlined" style="color: white; font-size: 16px;">
                                     ${item.type === 'lost' ? 'search' : 'check'}
                                 </span>
                               </div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    })
                }).addTo(miniMap);
                
                miniMap.invalidateSize();
            }, 100);
            
            hideLoading();
            
        } catch (error) {
            console.error("Detay yükleme hatası:", error);
            alert("İlan detayları yüklenirken bir hata oluştu.");
            hideLoading();
        }
    };

    window.closeDetailModal = () => {
        document.getElementById('detail-modal').classList.add('hidden');
    };

    window.markAsFound = async (itemId) => {
        if (confirm("Bu ilanı bulundu olarak işaretlemek istediğinize emin misiniz?")) {
            showLoading();
            try {
                await update(ref(db, `items/${itemId}`), {
                    type: 'found',
                    updatedAt: new Date().toISOString()
                });
                alert("✅ Başarıyla güncellendi!");
                closeDetailModal();
                if (document.getElementById('page-profile').classList.contains('hidden')) {
                    showPage('explore');
                } else {
                    loadProfilePage();
                }
            } catch (error) {
                console.error("Güncelleme hatası:", error);
                alert("Güncelleme sırasında bir hata oluştu.");
            } finally {
                hideLoading();
            }
        }
    };

    window.deleteItem = async (itemId) => {
        if (confirm("Bu ilanı silmek istediğinize emin misiniz? Bu işlem geri alınamaz.")) {
            showLoading();
            try {
                await remove(ref(db, `items/${itemId}`));
                alert("🗑️ İlan başarıyla silindi!");
                closeDetailModal();
                if (document.getElementById('page-profile').classList.contains('hidden')) {
                    showPage('explore');
                } else {
                    loadProfilePage();
                }
            } catch (error) {
                console.error("Silme hatası:", error);
                alert("İlan silinirken bir hata oluştu.");
            } finally {
                hideLoading();
            }
        }
    };

    // --- Profile Management ---
    function loadProfilePage() {
        const container = document.getElementById('profile-content');
        container.innerHTML = `
            <div class="flex flex-col items-center justify-center py-12">
                <div class="animate-spin w-8 h-8 border-2 border-charcoal/20 border-t-charcoal rounded-full mb-3"></div>
                <p class="text-sm text-charcoal/40">Yükleniyor...</p>
            </div>
        `;
        
        setTimeout(() => {
            showProfile(currentUser.uid);
        }, 300);
    }

    window.showProfile = async (userId) => {
        showLoading();
        try {
            const userSnap = await get(ref(db, `users/${userId}`));
            const userData = userSnap.val();
            
            const itemsSnap = await get(ref(db, 'items'));
            const userItems = [];
            itemsSnap.forEach((child) => {
                const item = child.val();
                if (item.userId === userId) {
                    userItems.push(item);
                }
            });
            
            const container = document.getElementById('profile-content');
            
            userItems.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            const totalAds = userItems.length;
            const lostAds = userItems.filter(item => item.type === 'lost').length;
            const foundAds = userItems.filter(item => item.type === 'found').length;
            
            container.innerHTML = `
                <div class="mb-8 lg:mb-12">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6 lg:mb-8">
                        <div>
                            <h2 class="text-3xl lg:text-4xl font-serif font-light italic mb-2">${userData?.name || 'Kullanıcı'}</h2>
                            <p class="text-sm lg:text-base text-charcoal/40">${userData?.email || currentUser?.email || ''}</p>
                            ${userData?.bio ? `<p class="text-sm lg:text-base text-charcoal/60 mt-2">${userData.bio}</p>` : ''}
                            ${userData?.contact ? `<p class="text-sm lg:text-base text-charcoal/40 mt-1">📞 ${userData.contact}</p>` : ''}
                        </div>
                        <div class="flex gap-2 lg:gap-3">
                            <button onclick="openProfileEditModal()" class="px-4 lg:px-6 py-2 lg:py-3 bg-charcoal text-white text-xs lg:text-sm rounded-lg lg:rounded-xl">
                                Profili Düzenle
                            </button>
                            <button onclick="logout()" class="px-4 lg:px-6 py-2 lg:py-3 bg-lost-red text-white text-xs lg:text-sm rounded-lg lg:rounded-xl">
                                Çıkış Yap
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 lg:gap-6 mb-8 lg:mb-12 profile-stats">
                        <div class="bg-off-white p-4 lg:p-6 rounded-lg lg:rounded-xl text-center">
                            <p class="text-xs lg:text-sm text-charcoal/40 uppercase tracking-widest mb-1 lg:mb-2">Toplam</p>
                            <p class="text-2xl lg:text-4xl font-light">${totalAds}</p>
                        </div>
                        <div class="bg-lost-red/5 p-4 lg:p-6 rounded-lg lg:rounded-xl text-center">
                            <p class="text-xs lg:text-sm text-charcoal/40 uppercase tracking-widest mb-1 lg:mb-2">Kayıp</p>
                            <p class="text-2xl lg:text-4xl font-light text-lost-red">${lostAds}</p>
                        </div>
                        <div class="bg-found-green/5 p-4 lg:p-6 rounded-lg lg:rounded-xl text-center">
                            <p class="text-xs lg:text-sm text-charcoal/40 uppercase tracking-widest mb-1 lg:mb-2">Bulunan</p>
                            <p class="text-2xl lg:text-4xl font-light text-found-green">${foundAds}</p>
                        </div>
                    </div>
                    
                    <div class="mb-8 lg:mb-12">
                        <div class="flex items-center justify-between mb-4 lg:mb-6">
                            <h3 class="text-lg lg:text-2xl font-serif font-light">İlanlarım</h3>
                            <button onclick="showPage('add')" class="px-3 lg:px-4 py-1.5 lg:py-2.5 bg-charcoal text-white text-xs lg:text-sm rounded-lg lg:rounded-xl">
                                + Yeni İlan
                            </button>
                        </div>
                        
                        <div id="prof-ads" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 lg:gap-6">
                            ${userItems.length > 0 ? userItems.map(item => `
                                <div class="bg-white rounded-lg lg:rounded-xl overflow-hidden thin-border cursor-pointer hover:shadow-sm transition" onclick="showItemDetailPopup('${item.id}')">
                                    <div class="relative h-48 lg:h-56 bg-charcoal/5">
                                        <img src="${item.image}" alt="${item.title}" class="w-full h-full object-cover">
                                        <div class="absolute top-2 left-2">
                                            <span class="px-2 py-0.5 ${item.type === 'lost' ? 'bg-lost-red/10 text-lost-red' : 'bg-found-green/10 text-found-green'} text-[10px] lg:text-xs uppercase tracking-widest rounded">
                                                ${item.type === 'lost' ? 'Kayıp' : 'Bulundu'}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="p-3 lg:p-4">
                                        <h4 class="font-medium text-sm lg:text-base mb-1 line-clamp-1">${item.title}</h4>
                                        <p class="text-xs lg:text-sm text-charcoal/40 mb-2 line-clamp-2">${item.description?.substring(0, 80) || ''}</p>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs lg:text-sm text-charcoal/30">${formatDate(item.createdAt)}</span>
                                            ${item.type === 'lost' ? `
                                                <button onclick="event.stopPropagation(); markAsFound('${item.id}')" 
                                                        class="px-2 py-1 lg:px-3 lg:py-1.5 bg-found-green/10 text-found-green text-xs lg:text-sm rounded hover:bg-found-green/20 transition">
                                                    ✅ Bulundu
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('') : `
                                <div class="col-span-full text-center py-12 lg:py-16">
                                    <div class="w-12 h-12 lg:w-16 lg:h-16 bg-charcoal/5 rounded-full flex items-center justify-center mx-auto mb-3 lg:mb-4">
                                        <span class="material-symbols-outlined text-charcoal/40 text-xl lg:text-2xl">inbox</span>
                                    </div>
                                    <p class="text-sm lg:text-base text-charcoal/40 mb-3 lg:mb-4">Henüz ilan bulunmuyor.</p>
                                    <button onclick="showPage('add')" class="px-4 lg:px-6 py-2 lg:py-3 bg-charcoal text-white text-xs lg:text-sm rounded-lg lg:rounded-xl">
                                        İlk İlanını Ver
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
            
            hideLoading();
            
        } catch (error) {
            console.error("Profil yükleme hatası:", error);
            container.innerHTML = `
                <div class="text-center py-12 lg:py-16">
                    <div class="w-12 h-12 lg:w-16 lg:h-16 bg-charcoal/5 rounded-full flex items-center justify-center mx-auto mb-3 lg:mb-4">
                        <span class="material-symbols-outlined text-charcoal/40 text-xl lg:text-2xl">error</span>
                    </div>
                    <p class="text-sm lg:text-base text-charcoal/40">Profil yüklenirken bir hata oluştu.</p>
                </div>
            `;
            hideLoading();
        }
    };

    window.openProfileEditModal = async () => {
        showLoading();
        try {
            const userSnap = await get(ref(db, `users/${currentUser.uid}`));
            const userData = userSnap.val();
            
            const modal = document.getElementById('profile-edit-modal');
            modal.innerHTML = `
                <div class="profile-edit-modal bg-white rounded-2xl overflow-hidden shadow-2xl slide-up max-h-[90vh] overflow-y-auto">
                    <div class="p-6 lg:p-8">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-2xl lg:text-3xl font-serif font-light">Profili Düzenle</h2>
                            <button onclick="closeProfileEditModal()" class="p-2 hover:bg-charcoal/5 rounded-lg transition">
                                <span class="material-symbols-outlined text-charcoal/60">close</span>
                            </button>
                        </div>
                        
                        <div class="space-y-6">
                            <div class="flex flex-col items-center">
                                <div class="relative mb-4">
                                    <img id="profile-preview" src="${userData?.profileImage || 'https://lh3.googleusercontent.com/aida-public/AB6AXuAHgmz9ZdyrrnVStj22LkErbA8T2RxayfdXNwm9XagSatARcd3ffXC_gnMjwdMeTVIM1_naprdoDBH5E3oQbSpPToZ9pFGChkcvGo7fUPwhQIeIDqqxkhg_0GG1S_EIbuKM63LbIbQBaMofSj_XkXehUr35iKp9AOfl7D_5tV9hf9L31MrtXPhZTrnFNVIgStVmeBJPzZwRvfbNPNyWtRAxeHdGww_HnK4TbZVi8SjQ246qUt_7_Kf_MPPuOxI2yvPYY3om-iE61Vc'}" 
                                         class="profile-avatar rounded-full border-4 border-white shadow-lg">
                                    <button onclick="document.getElementById('profile-image-input').click()" 
                                            class="absolute bottom-2 right-2 size-10 bg-charcoal text-white rounded-full flex items-center justify-center hover:bg-charcoal/90 transition">
                                        <span class="material-symbols-outlined text-sm">photo_camera</span>
                                    </button>
                                </div>
                                <input type="file" id="profile-image-input" class="hidden" accept="image/*">
                                <p class="text-xs text-charcoal/40">Profil fotoğrafı değiştir</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-charcoal/60 mb-2">Ad Soyad</label>
                                <input type="text" id="edit-name" value="${userData?.name || ''}" 
                                       class="w-full px-4 py-3 bg-off-white border thin-border rounded-lg focus:ring-1 focus:ring-charcoal focus:border-transparent outline-none">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-charcoal/60 mb-2">Bio</label>
                                <textarea id="edit-bio" rows="3" 
                                          class="w-full px-4 py-3 bg-off-white border thin-border rounded-lg focus:ring-1 focus:ring-charcoal focus:border-transparent outline-none resize-none bio-textarea">${userData?.bio || ''}</textarea>
                                <p class="text-xs text-charcoal/40 mt-1">Kendiniz hakkında kısa bir açıklama</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-charcoal/60 mb-2">İletişim Bilgileri</label>
                                <input type="text" id="edit-contact" value="${userData?.contact || ''}" 
                                       class="w-full px-4 py-3 bg-off-white border thin-border rounded-lg focus:ring-1 focus:ring-charcoal focus:border-transparent outline-none">
                                <p class="text-xs text-charcoal/40 mt-1">Telefon numarası veya diğer iletişim bilgileri</p>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-charcoal/60 mb-2">E-posta</label>
                                <input type="email" value="${currentUser?.email || ''}" disabled
                                       class="w-full px-4 py-3 bg-charcoal/5 border thin-border rounded-lg outline-none cursor-not-allowed">
                                <p class="text-xs text-charcoal/40 mt-1">E-posta değiştirilemez</p>
                            </div>
                            
                            <div class="pt-4">
                                <button onclick="saveProfileChanges()" class="w-full py-3 bg-found-green text-white font-medium rounded-lg hover:bg-found-green/90 transition">
                                    Değişiklikleri Kaydet
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
            
            // Profil fotoğrafı yükleme
            document.getElementById('profile-image-input').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        alert("Dosya boyutu 5MB'tan küçük olmalıdır.");
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        document.getElementById('profile-preview').src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            hideLoading();
            
        } catch (error) {
            console.error("Profil düzenleme modalı yükleme hatası:", error);
            alert("Profil düzenleme sayfası yüklenirken bir hata oluştu.");
            hideLoading();
        }
    };

    window.closeProfileEditModal = () => {
        document.getElementById('profile-edit-modal').classList.add('hidden');
    };

    window.saveProfileChanges = async () => {
        showLoading();
        
        try {
            const name = document.getElementById('edit-name').value.trim();
            const bio = document.getElementById('edit-bio').value.trim();
            const contact = document.getElementById('edit-contact').value.trim();
            const profileImageInput = document.getElementById('profile-image-input');
            
            const updates = {
                name: name || currentUser.email.split('@')[0],
                bio: bio,
                contact: contact,
                updatedAt: new Date().toISOString()
            };
            
            // Profil fotoğrafı güncelleme
            if (profileImageInput.files[0]) {
                const file = profileImageInput.files[0];
                const reader = new FileReader();
                
                reader.onload = async (event) => {
                    updates.profileImage = event.target.result;
                    
                    // Firebase Authentication'daki display name'i güncelle
                    await updateProfile(currentUser, {
                        displayName: updates.name
                    });
                    
                    // Database'de güncelle
                    await update(ref(db, `users/${currentUser.uid}`), updates);
                    
                    // Başarı mesajı
                    alert("✅ Profil başarıyla güncellendi!");
                    closeProfileEditModal();
                    loadProfilePage();
                    
                    // Header'ı güncelle
                    const headerImg = document.getElementById('header-profile-img');
                    if (headerImg) {
                        headerImg.src = updates.profileImage;
                    }
                    
                    hideLoading();
                };
                
                reader.readAsDataURL(file);
            } else {
                // Firebase Authentication'daki display name'i güncelle
                await updateProfile(currentUser, {
                    displayName: updates.name
                });
                
                // Database'de güncelle
                await update(ref(db, `users/${currentUser.uid}`), updates);
                
                // Başarı mesajı
                alert("✅ Profil başarıyla güncellendi!");
                closeProfileEditModal();
                loadProfilePage();
                hideLoading();
            }
            
        } catch (error) {
            console.error("Profil güncelleme hatası:", error);
            alert("Profil güncelleme sırasında bir hata oluştu: " + error.message);
            hideLoading();
        }
    };

    // --- Search and Filter ---
    window.setFilter = (filter) => {
        currentFilter = filter;
        
        ['lost', 'found', 'all'].forEach(f => {
            const btn = document.getElementById(`filter-${f}`);
            if (btn) {
                if (f === filter) {
                    btn.classList.remove('bg-off-white', 'text-lost-red', 'text-found-green', 'border', 'thin-border');
                    btn.classList.add('bg-charcoal', 'text-white');
                } else if (f === 'lost') {
                    btn.classList.remove('bg-charcoal', 'text-white', 'bg-off-white', 'text-found-green', 'border', 'thin-border');
                    btn.classList.add('bg-off-white', 'text-lost-red', 'border', 'thin-border');
                } else if (f === 'found') {
                    btn.classList.remove('bg-charcoal', 'text-white', 'bg-off-white', 'text-lost-red', 'border', 'thin-border');
                    btn.classList.add('bg-off-white', 'text-found-green', 'border', 'thin-border');
                }
            }
        });
        
        loadExploreItems();
    };

    // --- Utility Functions ---
    function formatDate(dateString) {
        if (!dateString) return 'Tarih yok';
        
        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;
        
        if (isNaN(diff)) return 'Tarih yok';
        
        if (diff < 60000) return 'Az önce';
        if (diff < 3600000) return `${Math.floor(diff / 60000)} dakika önce`;
        if (diff < 86400000) return `${Math.floor(diff / 3600000)} saat önce`;
        if (diff < 604800000) return `${Math.floor(diff / 86400000)} gün önce`;
        
        return date.toLocaleDateString('tr-TR', {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        });
    }

    // --- Auth State Listener ---
    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        
        if (user) {
            document.getElementById('auth-modal').classList.add('hidden');
            
            get(ref(db, `users/${user.uid}`)).then((snap) => {
                const userData = snap.val();
                
                document.getElementById('header-profile').innerHTML = `
                    <div class="flex items-center gap-3">
                        <button onclick="showPage('profile')" class="size-8 lg:size-10 overflow-hidden rounded-full ring-1 ring-charcoal/5">
                            <img id="header-profile-img" class="h-full w-full object-cover grayscale opacity-80" 
                                 src="${userData?.profileImage || 'https://lh3.googleusercontent.com/aida-public/AB6AXuAHgmz9ZdyrrnVStj22LkErbA8T2RxayfdXNwm9XagSatARcd3ffXC_gnMjwdMeTVIM1_naprdoDBH5E3oQbSpPToZ9pFGChkcvGo7fUPwhQIeIDqqxkhg_0GG1S_EIbuKM63LbIbQBaMofSj_XkXehUr35iKp9AOfl7D_5tV9hf9L31MrtXPhZTrnFNVIgStVmeBJPzZwRvfbNPNyWtRAxeHdGww_HnK4TbZVi8SjQ246qUt_7_Kf_MPPuOxI2yvPYY3om-iE61Vc'}">
                        </button>
                    </div>
                `;
            }).catch(() => {
                document.getElementById('header-profile').innerHTML = `
                    <div class="flex items-center gap-3">
                        <button onclick="showPage('profile')" class="size-8 lg:size-10 overflow-hidden rounded-full ring-1 ring-charcoal/5">
                            <img id="header-profile-img" class="h-full w-full object-cover grayscale opacity-80" 
                                 src="https://lh3.googleusercontent.com/aida-public/AB6AXuAHgmz9ZdyrrnVStj22LkErbA8T2RxayfdXNwm9XagSatARcd3ffXC_gnMjwdMeTVIM1_naprdoDBH5E3oQbSpPToZ9pFGChkcvGo7fUPwhQIeIDqqxkhg_0GG1S_EIbuKM63LbIbQBaMofSj_XkXehUr35iKp9AOfl7D_5tV9hf9L31MrtXPhZTrnFNVIgStVmeBJPzZwRvfbNPNyWtRAxeHdGww_HnK4TbZVi8SjQ246qUt_7_Kf_MPPuOxI2yvPYY3om-iE61Vc">
                        </button>
                    </div>
                `;
            });
            
            loadRecentItems();
            
        } else {
            document.getElementById('auth-modal').classList.remove('hidden');
            document.getElementById('header-profile').innerHTML = `
                <button onclick="document.getElementById('auth-modal').classList.remove('hidden')"
                        class="px-4 lg:px-6 py-2 lg:py-3 bg-charcoal text-white text-xs lg:text-sm font-medium rounded-lg lg:rounded-xl">
                    Giriş Yap
                </button>
            `;
        }
    });

</script>
</body>
</html>
