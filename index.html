<!DOCTYPE html>
<html class="light" lang="tr">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>kb. - Kayıp/Buluntu Platformu</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Custom Config -->
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#137fec",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                        "text-dark": "#0d141b",
                        "text-light": "#4c739a",
                        "found-green": "#059669",
                        "lost-red": "#dc2626"
                    },
                    fontFamily: {
                        "sans": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'float': 'float 6s ease-in-out infinite'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-10px)' }
                        }
                    }
                },
            },
        }
    </script>

    <style>
        @layer base {
            body {
                @apply bg-background-light dark:bg-background-dark text-text-dark dark:text-slate-100 font-sans antialiased;
                min-height: max(884px, 100dvh);
            }
        }
        
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        .item-image {
            height: 70vh;
            max-height: 700px;
            object-fit: cover;
        }
        
        @media (max-width: 1024px) {
            .item-image {
                height: 60vh;
                max-height: 500px;
            }
        }
        
        @media (max-width: 768px) {
            .item-image {
                height: 50vh;
                max-height: 400px;
            }
        }
        
        /* PC için geniş konteyner */
        .container-pc {
            max-width: 1600px;
            margin-left: auto;
            margin-right: auto;
            padding-left: 2rem;
            padding-right: 2rem;
        }
        
        @media (min-width: 1920px) {
            .container-pc {
                max-width: 1800px;
                padding-left: 3rem;
                padding-right: 3rem;
            }
        }
        
        /* Leaflet map fixes */
        .leaflet-container {
            font-family: 'Inter', sans-serif !important;
        }
        
        /* YENİ TEMA: Popup ve Modal Stilleri */
        .modal-overlay {
            backdrop-filter: blur(8px);
            background: rgba(0, 0, 0, 0.5);
        }
        
        .modal-container {
            max-width: 500px;
            width: 90vw;
            background: white;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            background: white;
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0d141b;
        }
        
        .modal-close-btn {
            width: 2rem;
            height: 2rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4c739a;
            transition: all 0.2s;
        }
        
        .modal-close-btn:hover {
            background: #f6f7f8;
            color: #0d141b;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            color: #0d141b;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #137fec;
            box-shadow: 0 0 0 3px rgba(19, 127, 236, 0.1);
        }
        
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #4c739a;
            margin-bottom: 0.5rem;
        }
        
        .primary-button {
            width: 100%;
            padding: 0.875rem;
            background: #137fec;
            color: white;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        
        .primary-button:hover {
            background: #0d6fd8;
        }
        
        .secondary-button {
            width: 100%;
            padding: 0.875rem;
            background: #f6f7f8;
            color: #0d141b;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
            border: 1px solid #e5e7eb;
            cursor: pointer;
        }
        
        .secondary-button:hover {
            background: #e5e7eb;
        }
        
        .danger-button {
            background: #dc2626;
            color: white;
        }
        
        .danger-button:hover {
            background: #b91c1c;
        }
        
        .success-button {
            background: #059669;
            color: white;
        }
        
        .success-button:hover {
            background: #047857;
        }
        
        /* İlan Detay Popup Yeni Tema */
        .detail-popup-container {
            max-width: 900px;
            width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .detail-image-container {
            position: relative;
            aspect-ratio: 16/9;
            overflow: hidden;
        }
        
        .detail-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .detail-badge {
            position: absolute;
            top: 1rem;
            left: 1rem;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .lost-badge {
            background: #dc2626;
            color: white;
        }
        
        .found-badge {
            background: #059669;
            color: white;
        }
        
        .detail-content {
            padding: 1.5rem;
        }
        
        .detail-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #0d141b;
            margin-bottom: 0.5rem;
        }
        
        .detail-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #4c739a;
            margin-bottom: 1.5rem;
        }
        
        .detail-section {
            margin-bottom: 1.5rem;
        }
        
        .section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #4c739a;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }
        
        .section-content {
            font-size: 0.875rem;
            color: #0d141b;
            line-height: 1.5;
            white-space: pre-line;
        }
        
        .contact-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: #f6f7f8;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #0d141b;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: #f6f7f8;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .user-info:hover {
            background: #e5e7eb;
        }
        
        .user-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 9999px;
            object-fit: cover;
            border: 2px solid #137fec;
        }
        
        .user-details p:first-child {
            font-size: 0.875rem;
            font-weight: 600;
            color: #0d141b;
        }
        
        .user-details p:last-child {
            font-size: 0.75rem;
            color: #4c739a;
        }
        
        .map-mini {
            height: 250px;
            border-radius: 0.75rem;
            overflow: hidden;
            background: #f6f7f8;
        }
        
        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }
        
        /* Konum Seçme Modalı */
        .location-modal-container {
            max-width: 600px;
            width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .location-map-container {
            height: 400px;
            border-radius: 0.75rem;
            overflow: hidden;
            background: #f6f7f8;
        }
        
        .location-info {
            padding: 1rem;
            background: #f0f9ff;
            border-radius: 0.75rem;
            border: 1px solid #bfdbfe;
        }
        
        .location-info-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #0d141b;
            margin-bottom: 0.5rem;
        }
        
        .location-coords {
            font-size: 0.75rem;
            color: #4c739a;
            margin-bottom: 0.25rem;
        }
        
        .location-address {
            font-size: 0.75rem;
            color: #6b7280;
        }
        
        /* Profil Düzenleme Modalı */
        .profile-edit-container {
            max-width: 500px;
            width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .profile-avatar-container {
            position: relative;
            width: 8rem;
            height: 8rem;
            margin: 0 auto 1.5rem auto;
        }
        
        .profile-avatar {
            width: 100%;
            height: 100%;
            border-radius: 9999px;
            object-fit: cover;
            border: 4px solid white;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .avatar-edit-btn {
            position: absolute;
            bottom: 0.5rem;
            right: 0.5rem;
            width: 2.5rem;
            height: 2.5rem;
            background: #137fec;
            color: white;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(19, 127, 236, 0.3);
            transition: all 0.2s;
        }
        
        .avatar-edit-btn:hover {
            background: #0d6fd8;
            transform: scale(1.1);
        }
        
        /* Loading Overlay */
        .loading-overlay {
            backdrop-filter: blur(8px);
            background: rgba(0, 0, 0, 0.5);
        }
        
        .loading-spinner {
            width: 3rem;
            height: 3rem;
            border: 3px solid #f6f7f8;
            border-top-color: #137fec;
            border-radius: 9999px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        /* Responsive adjustments */
        @media (min-width: 768px) {
            .modal-container {
                width: 450px;
            }
            
            .detail-popup-container {
                width: 800px;
            }
            
            .profile-edit-container {
                width: 450px;
            }
        }
        
        @media (min-width: 1024px) {
            .detail-popup-container {
                width: 900px;
            }
            
            .location-modal-container {
                width: 700px;
            }
        }
        
        /* Custom Leaflet popup styling */
        .leaflet-popup-content-wrapper {
            border-radius: 0.75rem !important;
            padding: 0 !important;
            overflow: hidden !important;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2) !important;
            border: 1px solid #e5e7eb !important;
        }
        
        .leaflet-popup-content {
            margin: 0 !important;
            width: 320px !important;
        }
        
        .leaflet-popup-tip {
            background: white !important;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2) !important;
        }
        
        /* FIX: Ensure popup is above everything */
        .leaflet-popup {
            z-index: 9999 !important;
        }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .modal-container,
            .detail-popup-container,
            .location-modal-container,
            .profile-edit-container {
                background: #1f2937;
                color: #f9fafb;
            }
            
            .modal-header {
                background: #1f2937;
                border-bottom-color: #374151;
            }
            
            .modal-title {
                color: #f9fafb;
            }
            
            .modal-close-btn {
                color: #9ca3af;
            }
            
            .modal-close-btn:hover {
                background: #374151;
                color: #f9fafb;
            }
            
            .form-input {
                background: #374151;
                border-color: #4b5563;
                color: #f9fafb;
            }
            
            .form-input:focus {
                border-color: #137fec;
                box-shadow: 0 0 0 3px rgba(19, 127, 236, 0.2);
            }
            
            .form-label {
                color: #9ca3af;
            }
            
            .contact-info {
                background: #374151;
                color: #f9fafb;
            }
            
            .user-info {
                background: #374151;
            }
            
            .user-info:hover {
                background: #4b5563;
            }
            
            .user-details p:first-child {
                color: #f9fafb;
            }
            
            .map-mini {
                background: #374151;
            }
            
            .action-buttons {
                border-top-color: #374151;
            }
            
            .location-info {
                background: #1e3a8a;
                border-color: #1d4ed8;
            }
            
            .leaflet-popup-content-wrapper {
                background: #1f2937 !important;
                border-color: #374151 !important;
            }
            
            .leaflet-popup-tip {
                background: #1f2937 !important;
            }
        }
    </style>
</head>
<body class="min-h-screen">

<!-- Authentication Modal (YENİ TEMA) -->
<div id="auth-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay fade-in hidden">
    <div class="modal-container slide-up">
        <div class="modal-header">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-primary rounded-full flex items-center justify-center">
                        <span class="material-symbols-outlined text-white text-2xl">search_check</span>
                    </div>
                    <div>
                        <h2 id="auth-title" class="modal-title">Giriş Yap</h2>
                        <p class="text-sm text-text-light">Topluluğa katıl, kayıp ve buluntuları yönet</p>
                    </div>
                </div>
                <button onclick="closeAuthModal()" 
                        class="modal-close-btn">
                    <span class="material-symbols-outlined text-xl">close</span>
                </button>
            </div>
        </div>
        
        <div class="modal-body">
            <div class="space-y-4">
                <div>
                    <label class="form-label">E-posta</label>
                    <input type="email" id="auth-email" placeholder="ornek@email.com" 
                           class="form-input">
                </div>
                
                <div>
                    <label class="form-label">Şifre</label>
                    <input type="password" id="auth-pass" placeholder="••••••••" 
                           class="form-input">
                </div>
                
                <button onclick="handleAuth()" id="auth-btn" 
                        class="primary-button">
                    <span id="auth-btn-text">GİRİŞ YAP</span>
                </button>
                
                <div class="text-center pt-4">
                    <p onclick="toggleAuthMode()" id="auth-toggle" 
                       class="text-sm text-text-light hover:text-text-dark cursor-pointer transition">
                        Hesabınız yok mu? <span class="underline">Kayıt Ol</span>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay (YENİ TEMA) -->
<div id="loading-overlay" class="fixed inset-0 z-[60] loading-overlay flex items-center justify-center hidden fade-in">
    <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-xl">
        <div class="flex flex-col items-center gap-4">
            <div class="loading-spinner"></div>
            <p class="text-sm text-text-light dark:text-gray-300">Yükleniyor...</p>
        </div>
    </div>
</div>

<!-- Item Detail Popup (YENİ TEMA) -->
<div id="detail-modal" class="fixed inset-0 z-[9999] flex items-center justify-center p-4 modal-overlay fade-in hidden">
    <div class="detail-popup-container slide-up">
        <!-- Content will be loaded here -->
    </div>
</div>

<!-- Profile Edit Modal (YENİ TEMA) -->
<div id="profile-edit-modal" class="fixed inset-0 z-[9999] flex items-center justify-center p-4 modal-overlay fade-in hidden">
    <div class="profile-edit-container slide-up">
        <!-- Profile edit content will be loaded here -->
    </div>
</div>

<!-- Header (Mevcut) -->
<header class="sticky top-0 z-40 bg-white/80 dark:bg-background-dark/80 backdrop-blur-md px-6 lg:px-12 py-5 flex items-center justify-between border-b border-gray-200 dark:border-gray-800">
    <div class="flex items-center gap-2 cursor-pointer" onclick="showPage('home')">
        <span class="text-2xl lg:text-3xl font-bold tracking-tight text-primary">kb.</span>
    </div>
    
    <div id="header-profile" class="flex items-center gap-3">
        <!-- User avatar will be inserted here -->
    </div>
</header>

<!-- Main Content (Mevcut) -->
<main class="flex-1 pb-32 container-pc">
    <!-- Ana Sayfa -->
    <section id="page-home" class="space-y-12 lg:space-y-20 fade-in">
        <!-- Hero Section -->
        <section class="px-6 lg:px-12 pt-8 lg:pt-16 pb-12 lg:pb-20 text-center relative overflow-hidden">
            <h1 class="text-4xl lg:text-6xl font-bold mb-4 lg:mb-6 text-text-dark dark:text-white">Kayıp olanı bul.</h1>
            <p class="text-text-light uppercase tracking-widest mb-12 lg:mb-16">Özenle seçilmiş kayıp & buluntu platformu</p>
            
            <!-- İstatistikler -->
            <div class="grid grid-cols-3 gap-4 lg:gap-8 max-w-md lg:max-w-xl mx-auto mt-12 lg:mt-16">
                <div class="text-center bg-white dark:bg-gray-800 p-4 lg:p-6 rounded-xl shadow-sm">
                    <div class="text-2xl lg:text-4xl font-bold text-primary mb-1 lg:mb-2">150+</div>
                    <div class="text-xs lg:text-sm text-text-light uppercase tracking-widest">Bulunan</div>
                </div>
                <div class="text-center bg-white dark:bg-gray-800 p-4 lg:p-6 rounded-xl shadow-sm">
                    <div class="text-2xl lg:text-4xl font-bold text-primary mb-1 lg:mb-2">89</div>
                    <div class="text-xs lg:text-sm text-text-light uppercase tracking-widest">Mutlu An</div>
                </div>
                <div class="text-center bg-white dark:bg-gray-800 p-4 lg:p-6 rounded-xl shadow-sm">
                    <div class="text-2xl lg:text-4xl font-bold text-primary mb-1 lg:mb-2">24/7</div>
                    <div class="text-xs lg:text-sm text-text-light uppercase tracking-widest">Aktif</div>
                </div>
            </div>
        </section>
        
        <!-- Son İlanlar -->
        <div class="px-6 lg:px-12 space-y-8 lg:space-y-12">
            <div class="flex items-end justify-between px-2">
                <h2 class="text-3xl lg:text-4xl font-bold text-text-dark dark:text-white">Son Kayıtlar</h2>
                <button onclick="showPage('explore')" class="text-xs uppercase tracking-widest text-text-light hover:text-text-dark transition">Tümünü Gör</button>
            </div>
            
            <div id="recent-items" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- İlanlar buraya yüklenecek -->
                <div class="text-center py-12 col-span-full">
                    <div class="flex flex-col items-center gap-4">
                        <div class="loading-spinner"></div>
                        <p class="text-sm text-text-light">Yükleniyor...</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Keşfet Sayfası -->
    <section id="page-explore" class="hidden px-6 lg:px-12 space-y-12 lg:space-y-16">
        <div class="flex items-end justify-between px-2 pt-8">
            <h2 class="text-3xl lg:text-4xl font-bold text-text-dark dark:text-white">Tüm İlanlar</h2>
            <div class="flex gap-2 lg:gap-3">
                <button onclick="setFilter('all')" id="filter-all" class="px-4 py-2 text-xs uppercase tracking-widest bg-primary text-white rounded">Tümü</button>
                <button onclick="setFilter('lost')" id="filter-lost" class="px-4 py-2 text-xs uppercase tracking-widest bg-white text-lost-red border rounded">Kayıp</button>
                <button onclick="setFilter('found')" id="filter-found" class="px-4 py-2 text-xs uppercase tracking-widest bg-white text-found-green border rounded">Bulunan</button>
            </div>
        </div>
        
        <!-- Arama Çubuğu -->
        <div class="max-w-lg mx-auto">
            <div class="relative">
                <input type="text" id="search-input" placeholder="İlanlarda ara..."
                       class="w-full px-6 py-4 bg-white border rounded-xl focus:ring-2 focus:ring-primary focus:border-transparent outline-none text-base pl-12">
                <span class="material-symbols-outlined absolute left-4 top-1/2 transform -translate-y-1/2 text-text-light">
                    search
                </span>
            </div>
        </div>
        
        <div id="explore-items" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- İlanlar buraya yüklenecek -->
        </div>
    </section>
    
    <!-- Harita Görünümü -->
    <section id="page-map-view" class="hidden px-4 lg:px-12 space-y-8 lg:space-y-12">
        <div class="flex items-end justify-between px-2 pt-8">
            <h2 class="text-3xl lg:text-4xl font-bold text-text-dark dark:text-white">Harita Görünümü</h2>
            <div class="flex gap-2 lg:gap-3">
                <button onclick="showAllMarkers()" class="px-4 py-2 text-xs uppercase tracking-widest bg-primary text-white rounded">Tümü</button>
                <button onclick="filterMarkers('lost')" class="px-4 py-2 text-xs uppercase tracking-widest bg-white text-lost-red border rounded">Kayıp</button>
                <button onclick="filterMarkers('found')" class="px-4 py-2 text-xs uppercase tracking-widest bg-white text-found-green border rounded">Bulunan</button>
            </div>
        </div>
        
        <div class="bg-white rounded-xl overflow-hidden border shadow-sm">
            <div id="turkey-map" class="w-full h-[500px]"></div>
        </div>
        
        <div id="map-items-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Harita öğeleri buraya yüklenecek -->
        </div>
    </section>
    
    <!-- İlan Ekle Sayfası -->
    <section id="page-add" class="hidden">
        <div class="max-w-2xl mx-auto px-6 lg:px-0 py-8 lg:py-12">
            <div class="mb-8 lg:mb-12">
                <h2 class="text-3xl lg:text-4xl font-bold text-text-dark dark:text-white mb-2">Yeni İlan Oluştur</h2>
                <p class="text-base text-text-light">Kayıp veya buluntu ilanınızı toplulukla paylaşın</p>
            </div>
            
            <div class="space-y-6 lg:space-y-8">
                <div>
                    <label class="block text-base font-medium text-text-light mb-3">İlan Türü</label>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="type-lost" onclick="setAdType('lost')" class="py-5 rounded-xl bg-white border text-lost-red font-bold hover:border-lost-red transition">
                            <span class="flex items-center justify-center gap-3">
                                <span class="material-symbols-outlined">search</span>
                                Kayıp
                            </span>
                        </button>
                        <button id="type-found" onclick="setAdType('found')" class="py-5 rounded-xl bg-white border text-text-light font-bold hover:border-found-green hover:text-found-green transition">
                            <span class="flex items-center justify-center gap-3">
                                <span class="material-symbols-outlined">check_circle</span>
                                Bulundu
                            </span>
                        </button>
                    </div>
                </div>
                
                <div>
                    <label class="form-label">Başlık</label>
                    <input type="text" id="add-title" placeholder="Golden Retriever kayıp, Cüzdan bulundu..." 
                           class="form-input">
                </div>
                
                <div>
                    <label class="form-label">Açıklama</label>
                    <textarea id="add-desc" rows="4" placeholder="Detaylı açıklama (özellikler, son görüldüğü yer, iletişim bilgileri vb.)..." 
                              class="form-input resize-none"></textarea>
                </div>
                
                <div>
                    <label class="form-label">İletişim Numarası</label>
                    <input type="tel" id="add-phone" placeholder="+90 555 123 45 67" 
                           class="form-input">
                </div>
                
                <div>
                    <label class="form-label">Konum Seçimi</label>
                    <div class="space-y-4">
                        <button type="button" onclick="openLocationPicker()" id="location-picker-btn" 
                                class="primary-button">
                            <span class="material-symbols-outlined">location_on</span>
                            Konumu Haritadan Seç
                        </button>
                        
                        <div id="selected-location-info" class="hidden bg-blue-50 border border-blue-200 rounded-xl p-4">
                            <div class="flex items-start justify-between">
                                <div>
                                    <p class="text-sm font-bold text-text-dark mb-1">Seçilen Konum:</p>
                                    <p id="location-coordinates" class="text-xs text-text-light">Koordinatlar yükleniyor...</p>
                                    <p id="location-address" class="text-xs text-gray-500 mt-1">Adres bilgisi alınıyor...</p>
                                </div>
                                <button type="button" onclick="openLocationPicker()" class="text-xs text-primary hover:underline">
                                    Değiştir
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <label class="form-label">Fotoğraf</label>
                    <div onclick="document.getElementById('file-input').click()" class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer hover:border-primary transition bg-white">
                        <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center">
                            <span class="material-symbols-outlined text-gray-400 text-2xl">photo_camera</span>
                        </div>
                        <p class="text-base text-text-light">Fotoğraf yüklemek için tıklayın</p>
                        <p class="text-sm text-gray-500 mt-2">PNG, JPG (Maks. 5MB)</p>
                        <input type="file" id="file-input" class="hidden" accept="image/*">
                    </div>
                    <div id="image-preview" class="mt-6 hidden">
                        <img id="preview-img" class="w-full max-h-80 object-contain rounded-xl border">
                    </div>
                </div>
                
                <button onclick="saveAd()" id="save-btn" 
                        class="primary-button">
                    <span id="save-btn-text">İlanı Yayınla</span>
                </button>
            </div>
        </div>
    </section>
    
    <!-- Profil Sayfası -->
    <section id="page-profile" class="hidden">
        <div id="profile-content" class="max-w-6xl mx-auto px-6 lg:px-0 py-8 lg:py-12">
            <!-- Profil içeriği buraya yüklenecek -->
        </div>
    </section>
</main>

<!-- Alt Navigasyon -->
<nav class="fixed bottom-0 left-0 right-0 z-50 px-6 pb-6 pt-4 bg-white/90 dark:bg-slate-900/90 backdrop-blur-lg border-t border-gray-200 dark:border-gray-800">
    <div class="flex max-w-md mx-auto justify-around items-center">
        <button data-page="home" class="flex flex-col items-center gap-1 text-primary">
            <span class="material-symbols-outlined">home</span>
            <span class="text-[10px] font-semibold">Ana Sayfa</span>
        </button>
        <button data-page="map-view" class="flex flex-col items-center gap-1 text-gray-400">
            <span class="material-symbols-outlined">map</span>
            <span class="text-[10px] font-medium">Harita</span>
        </button>
        <button data-page="add" class="relative -top-12 flex items-center justify-center size-16 bg-primary text-white rounded-full shadow-lg hover:scale-105 transition-transform z-50">
            <span class="material-symbols-outlined text-3xl">add</span>
        </button>
        <button data-page="explore" class="flex flex-col items-center gap-1 text-gray-400">
            <span class="material-symbols-outlined">explore</span>
            <span class="text-[10px] font-medium">Keşfet</span>
        </button>
        <button data-page="profile" class="flex flex-col items-center gap-1 text-gray-400">
            <span class="material-symbols-outlined">person</span>
            <span class="text-[10px] font-medium">Profil</span>
        </button>
    </div>
</nav>

<!-- Konum Seçme Modalı (YENİ TEMA) -->
<div id="location-modal" class="fixed inset-0 z-[9998] flex items-center justify-center p-4 modal-overlay fade-in hidden">
    <div class="location-modal-container slide-up">
        <div class="modal-header">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center">
                        <span class="material-symbols-outlined text-white">location_on</span>
                    </div>
                    <div>
                        <h2 class="modal-title">Konum Seç</h2>
                        <p class="text-sm text-text-light">Kayıp/Buluntu konumunu haritadan seçin</p>
                    </div>
                </div>
                <button onclick="closeLocationModal()" class="modal-close-btn">
                    <span class="material-symbols-outlined text-xl">close</span>
                </button>
            </div>
        </div>
        
        <div class="modal-body">
            <div class="space-y-4">
                <div>
                    <p class="text-sm text-text-light mb-2">Haritada kaybolan/bulunan eşyanın konumunu seçin:</p>
                    <div class="flex items-center gap-2 text-xs text-text-light">
                        <span class="material-symbols-outlined text-sm">info</span>
                        İstediğiniz yeri tıklayın veya haritayı kaydırarak konumu bulun
                    </div>
                </div>
                
                <div id="location-modal-map" class="location-map-container"></div>
                
                <div class="location-info">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <p class="location-info-title">Seçilen Konum:</p>
                            <p id="modal-location-coords" class="location-coords">Koordinatlar: -</p>
                            <p id="modal-location-address" class="location-address">Adres: Konum seçilmedi</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="getUserLocation()" 
                                    class="px-3 py-2 bg-primary text-white text-xs rounded-lg hover:bg-primary/90 flex items-center gap-1">
                                <span class="material-symbols-outlined text-sm">my_location</span>
                                Mevcut Konum
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="saveSelectedLocation()" id="confirm-location-btn" disabled
                                class="primary-button success-button disabled:opacity-50 disabled:cursor-not-allowed">
                            Konumu Onayla
                        </button>
                        <button onclick="closeLocationModal()" 
                                class="secondary-button">
                            İptal
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Firebase and App Logic -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getDatabase, ref, push, set, onValue, update, get, remove, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBB_cc3y2r8qvZQx1wwmNyhqu6joYumj3Q",
        authDomain: "ekopsim.firebaseapp.com",
        databaseURL: "https://ekopsim-default-rtdb.firebaseio.com",
        projectId: "ekopsim",
        storageBucket: "ekopsim.firebasestorage.app",
        messagingSenderId: "488553599548",
        appId: "1:488553599548:web:cbbf5ec6ab5f3ca1912939"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let currentUser = null;
    let currentFilter = 'all';
    let adType = 'lost';
    let turkeyMap = null;
    let locationMap = null;
    let markers = [];
    let selectedImage = null;
    let isLoading = false;
    let currentPopup = null;
    
    // Yeni değişkenler: Konum seçimi için
    let selectedLat = null;
    let selectedLng = null;
    let selectedAddress = "Konum seçilmedi";
    let locationMarker = null;
    
    // Arama değişkeni
    let searchTerm = '';
    let allItems = [];

    // --- Utility Functions ---
    function formatDate(dateString) {
        if (!dateString) return 'Tarih yok';
        
        const date = new Date(dateString);
        const now = new Date();
        const diff = now - date;
        
        if (isNaN(diff)) return 'Tarih yok';
        
        if (diff < 60000) return 'Az önce';
        if (diff < 3600000) return `${Math.floor(diff / 60000)} dakika önce`;
        if (diff < 86400000) return `${Math.floor(diff / 3600000)} saat önce`;
        if (diff < 604800000) return `${Math.floor(diff / 86400000)} gün önce`;
        
        return date.toLocaleDateString('tr-TR', {
            day: 'numeric',
            month: 'long',
            year: 'numeric'
        });
    }

    // --- Loading Overlay ---
    function showLoading() {
        if (!isLoading) {
            isLoading = true;
            document.getElementById('loading-overlay').classList.remove('hidden');
        }
    }

    function hideLoading() {
        isLoading = false;
        document.getElementById('loading-overlay').classList.add('hidden');
    }

    // --- Bottom Navigation Setup ---
    function setupBottomNavigation() {
        const navButtons = document.querySelectorAll('nav button[data-page]');
        navButtons.forEach(button => {
            button.addEventListener('click', function() {
                const page = this.getAttribute('data-page');
                if (page) {
                    showPage(page);
                }
            });
        });
    }

    // --- Modal Functions ---
    window.closeAuthModal = () => {
        document.getElementById('auth-modal').classList.add('hidden');
    };

    window.closeDetailModal = () => {
        document.getElementById('detail-modal').classList.add('hidden');
    };

    window.closeProfileEditModal = () => {
        document.getElementById('profile-edit-modal').classList.add('hidden');
    };

    window.closeLocationModal = () => {
        document.getElementById('location-modal').classList.add('hidden');
        if (locationMap) {
            locationMap.remove();
            locationMap = null;
            locationMarker = null;
        }
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        setupBottomNavigation();
        showPage('home');
        setAdType('lost');
        setFilter('all');
        
        // Arama input event listener
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                searchTerm = this.value.toLowerCase();
                loadExploreItems();
            });
        }

        // File input event listener
        const fileInput = document.getElementById('file-input');
        if (fileInput) {
            fileInput.addEventListener('change', handleImageUpload);
        }
    });

    function handleImageUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        if (file.size > 5 * 1024 * 1024) {
            alert("Dosya boyutu 5MB'tan küçük olmalıdır.");
            return;
        }
        
        selectedImage = file;
        const reader = new FileReader();
        reader.onload = (event) => {
            const preview = document.getElementById('preview-img');
            preview.src = event.target.result;
            document.getElementById('image-preview').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }

    // --- Konum Seçme Fonksiyonları ---
    window.openLocationPicker = () => {
        document.getElementById('location-modal').classList.remove('hidden');
        initLocationMap();
    };

    function initLocationMap() {
        if (!locationMap) {
            const mapElement = document.getElementById('location-modal-map');
            if (!mapElement) return;
            
            // Önceki haritayı temizle
            mapElement.innerHTML = '';
            
            // Varsayılan konum: İstanbul
            const defaultLat = selectedLat || 41.0082;
            const defaultLng = selectedLng || 28.9784;
            
            locationMap = L.map('location-modal-map').setView([defaultLat, defaultLng], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                minZoom: 6,
                maxZoom: 18
            }).addTo(locationMap);
            
            // Türkiye sınırlarını kısıtla
            locationMap.setMaxBounds([
                [35.8, 25.6],
                [42.1, 44.8]
            ]);
            
            // Eğer daha önce seçilmiş konum varsa marker ekle
            if (selectedLat && selectedLng) {
                addLocationMarker(selectedLat, selectedLng);
                updateLocationInfo(selectedLat, selectedLng);
                document.getElementById('confirm-location-btn').disabled = false;
            }
            
            // Haritaya tıklanınca konum seç
            locationMap.on('click', (e) => {
                addLocationMarker(e.latlng.lat, e.latlng.lng);
                updateLocationInfo(e.latlng.lat, e.latlng.lng);
                getAddressFromCoordinates(e.latlng.lat, e.latlng.lng);
                document.getElementById('confirm-location-btn').disabled = false;
            });
            
            setTimeout(() => {
                locationMap.invalidateSize();
            }, 100);
        }
    }

    function addLocationMarker(lat, lng) {
        // Önceki marker'ı temizle
        if (locationMarker) {
            locationMap.removeLayer(locationMarker);
        }
        
        // Yeni marker ekle
        locationMarker = L.marker([lat, lng], {
            icon: L.divIcon({
                className: 'custom-location-marker',
                html: `<div style="width: 32px; height: 32px; background-color: #137fec; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;">
                         <span class="material-symbols-outlined" style="color: white; font-size: 16px;">
                           location_on
                         </span>
                       </div>`,
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            })
        }).addTo(locationMap);
        
        // Haritayı seçilen konuma kaydır
        locationMap.setView([lat, lng], 13);
        
        // Seçilen koordinatları kaydet
        selectedLat = lat;
        selectedLng = lng;
    }

    function updateLocationInfo(lat, lng) {
        document.getElementById('modal-location-coords').textContent = 
            `Koordinatlar: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
    }

    async function getAddressFromCoordinates(lat, lng) {
        try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`);
            const data = await response.json();
            
            if (data && data.address) {
                const addressParts = [];
                
                if (data.address.road) addressParts.push(data.address.road);
                if (data.address.neighbourhood) addressParts.push(data.address.neighbourhood);
                if (data.address.suburb) addressParts.push(data.address.suburb);
                if (data.address.city) addressParts.push(data.address.city);
                if (data.address.county) addressParts.push(data.address.county);
                
                selectedAddress = addressParts.join(', ') || 'Adres bilgisi alınamadı';
            } else {
                selectedAddress = 'Adres bilgisi alınamadı';
            }
            
            document.getElementById('modal-location-address').textContent = `Adres: ${selectedAddress}`;
        } catch (error) {
            console.error('Adres alınamadı:', error);
            selectedAddress = 'Adres alınamadı';
            document.getElementById('modal-location-address').textContent = `Adres: ${selectedAddress}`;
        }
    }

    window.getUserLocation = () => {
        if (navigator.geolocation) {
            showLoading();
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Türkiye sınırları içinde mi kontrol et
                    if (lat >= 35.8 && lat <= 42.1 && lng >= 25.6 && lng <= 44.8) {
                        addLocationMarker(lat, lng);
                        updateLocationInfo(lat, lng);
                        getAddressFromCoordinates(lat, lng);
                        document.getElementById('confirm-location-btn').disabled = false;
                    } else {
                        alert('Lütfen Türkiye sınırları içinde bir konum seçin.');
                        addLocationMarker(41.0082, 28.9784); // İstanbul'a dön
                        updateLocationInfo(41.0082, 28.9784);
                        getAddressFromCoordinates(41.0082, 28.9784);
                    }
                    hideLoading();
                },
                (error) => {
                    console.error('Konum alınamadı:', error);
                    alert('Konumunuz alınamadı. Lütfen haritadan konum seçin.');
                    hideLoading();
                }
            );
        } else {
            alert('Tarayıcınız konum servisini desteklemiyor. Lütfen haritadan konum seçin.');
        }
    };

    window.saveSelectedLocation = () => {
        if (selectedLat && selectedLng) {
            // Formda göster
            document.getElementById('selected-location-info').classList.remove('hidden');
            document.getElementById('location-coordinates').textContent = 
                `Koordinatlar: ${selectedLat.toFixed(6)}, ${selectedLng.toFixed(6)}`;
            document.getElementById('location-address').textContent = `Adres: ${selectedAddress}`;
            
            // Butonu güncelle
            const btn = document.getElementById('location-picker-btn');
            btn.innerHTML = `
                <span class="material-symbols-outlined">check_circle</span>
                Konum Seçildi
            `;
            btn.classList.add('active');
            
            closeLocationModal();
        }
    };

    // --- Authentication ---
    window.toggleAuthMode = () => {
        const title = document.getElementById('auth-title');
        const btn = document.getElementById('auth-btn-text');
        const toggle = document.getElementById('auth-toggle');
        
        if (title.textContent === "Giriş Yap") {
            title.textContent = "Kayıt Ol";
            btn.textContent = "KAYIT OL";
            toggle.innerHTML = 'Zaten hesabınız var mı? <span class="underline">Giriş Yap</span>';
        } else {
            title.textContent = "Giriş Yap";
            btn.textContent = "GİRİŞ YAP";
            toggle.innerHTML = 'Hesabınız yok mu? <span class="underline">Kayıt Ol</span>';
        }
    };

    window.handleAuth = async () => {
        const email = document.getElementById('auth-email').value.trim();
        const pass = document.getElementById('auth-pass').value;
        
        if (!email || !pass) {
            alert("Lütfen tüm alanları doldurun.");
            return;
        }
        
        const btn = document.getElementById('auth-btn');
        const btnText = document.getElementById('auth-btn-text');
        const originalText = btnText.textContent;
        btnText.textContent = "İşleniyor...";
        btn.disabled = true;
        
        showLoading();
        
        try {
            if (originalText === "KAYIT OL") {
                const cred = await createUserWithEmailAndPassword(auth, email, pass);
                await set(ref(db, `users/${cred.user.uid}`), {
                    name: email.split('@')[0],
                    email: email,
                    bio: "",
                    phone: "",
                    contact: "",
                    profileImage: "",
                    createdAt: new Date().toISOString()
                });
                alert("🎉 Kayıt başarılı! Topluluğumuza hoş geldiniz.");
            } else {
                await signInWithEmailAndPassword(auth, email, pass);
            }
        } catch (error) {
            alert("Hata: " + error.message);
        } finally {
            hideLoading();
            btnText.textContent = originalText;
            btn.disabled = false;
        }
    };

    window.logout = async () => {
        if (confirm("Çıkış yapmak istediğinize emin misiniz?")) {
            showLoading();
            try {
                await signOut(auth);
                showPage('home');
                document.getElementById('auth-modal').classList.remove('hidden');
            } catch (error) {
                console.error("Çıkış hatası:", error);
                alert("Çıkış yapılırken bir hata oluştu.");
            } finally {
                hideLoading();
            }
        }
    };

    // --- Page Management ---
    window.showPage = (pageId) => {
        if (isLoading) return;
        
        showLoading();
        
        closeDetailModal();
        closeLocationModal();
        closeProfileEditModal();
        
        if (currentPopup && turkeyMap) {
            turkeyMap.closePopup(currentPopup);
            currentPopup = null;
        }
        
        document.querySelectorAll('main > section').forEach(section => {
            section.classList.add('hidden');
        });
        
        const pageElement = document.getElementById(`page-${pageId}`);
        if (pageElement) {
            pageElement.classList.remove('hidden');
            
            // İlan ekleme sayfasına geçtiğimizde konum seçimini sıfırla
            if (pageId === 'add') {
                resetLocationSelection();
            }
        } else {
            if (pageId === 'profile') {
                const container = document.getElementById('page-profile');
                container.classList.remove('hidden');
            }
        }
        
        setTimeout(() => {
            try {
                switch(pageId) {
                    case 'home':
                        loadRecentItems();
                        break;
                    case 'explore':
                        loadExploreItems();
                        break;
                    case 'map-view':
                        initTurkeyMap();
                        loadMapItems();
                        break;
                    case 'profile':
                        if (currentUser) {
                            loadProfilePage();
                        } else {
                            showPage('home');
                            document.getElementById('auth-modal').classList.remove('hidden');
                        }
                        break;
                }
            } catch (error) {
                console.error(`Sayfa yükleme hatası (${pageId}):`, error);
                alert("Sayfa yüklenirken bir hata oluştu.");
            } finally {
                hideLoading();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }, 300);
    };

    function resetLocationSelection() {
        selectedLat = null;
        selectedLng = null;
        selectedAddress = "Konum seçilmedi";
        
        document.getElementById('selected-location-info').classList.add('hidden');
        const btn = document.getElementById('location-picker-btn');
        btn.innerHTML = `
            <span class="material-symbols-outlined">location_on</span>
            Konumu Haritadan Seç
        `;
        btn.classList.remove('active');
    }

    // --- Map Management ---
    function initTurkeyMap() {
        const mapElement = document.getElementById('turkey-map');
        if (!mapElement) return;
        
        if (!turkeyMap) {
            turkeyMap = L.map('turkey-map').setView([39.0, 35.0], 6);
            
            turkeyMap.setMaxBounds([
                [35.8, 25.6],
                [42.1, 44.8]
            ]);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                minZoom: 6,
                maxZoom: 12
            }).addTo(turkeyMap);
            
            turkeyMap.on('click', (e) => {
                if (currentPopup && turkeyMap) {
                    turkeyMap.closePopup(currentPopup);
                    currentPopup = null;
                }
            });
            
            turkeyMap.on('popupopen', (e) => {
                currentPopup = e.popup;
            });
            
            turkeyMap.on('popupclose', () => {
                currentPopup = null;
            });
        }
        
        setTimeout(() => {
            turkeyMap.invalidateSize();
        }, 100);
    }

    window.showAllMarkers = () => {
        clearMarkers();
        loadMapItems();
    };

    window.filterMarkers = (type) => {
        clearMarkers();
        loadMapItems(type);
    };

    function clearMarkers() {
        markers.forEach(marker => {
            if (turkeyMap && marker) {
                turkeyMap.removeLayer(marker);
            }
        });
        markers = [];
    }

    function loadMapItems(filterType = 'all') {
        const container = document.getElementById('map-items-list');
        container.innerHTML = '<div class="col-span-full text-center py-12"><div class="loading-spinner mx-auto"></div></div>';
        
        onValue(ref(db, 'items'), (snapshot) => {
            const items = [];
            snapshot.forEach((child) => {
                const item = child.val();
                if (filterType === 'all' || item.type === filterType) {
                    items.push(item);
                }
            });
            
            clearMarkers();
            
            items.forEach(item => {
                if (item.lat && item.lng) {
                    const markerColor = item.type === 'lost' ? '#dc2626' : '#059669';
                    const iconColor = item.userId === currentUser?.uid ? '#137fec' : markerColor;
                    
                    const markerIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background-color: ${iconColor}; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                 <span class="material-symbols-outlined" style="color: white; font-size: 16px;">
                                     ${item.type === 'lost' ? 'search' : 'check'}
                                 </span>
                               </div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });
                    
                    const mapMarker = L.marker([item.lat, item.lng], { icon: markerIcon }).addTo(turkeyMap);
                    
                    const popupContent = `
                        <div style="min-width: 250px; padding: 1rem; font-family: 'Inter', sans-serif; background: white; border-radius: 0.75rem;">
                            <div style="display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div style="width: 60px; height: 60px; border-radius: 0.5rem; overflow: hidden; flex-shrink: 0;">
                                    <img src="${item.image}" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                                <div>
                                    <div style="display: flex; align-items: center; gap: 0.375rem; margin-bottom: 0.25rem;">
                                        <div style="width: 8px; height: 8px; border-radius: 50%; background-color: ${item.type === 'lost' ? '#dc2626' : '#059669'}"></div>
                                        <strong style="font-size: 0.875rem; font-weight: 600; color: #0d141b;">${item.title}</strong>
                                    </div>
                                    <p style="font-size: 0.75rem; color: #4c739a; margin-bottom: 0.5rem; line-height: 1.4;">
                                        ${item.description.substring(0, 80)}${item.description.length > 80 ? '...' : ''}
                                    </p>
                                </div>
                            </div>
                            <button onclick="window.handleMapPopupDetail('${item.id}')" style="width: 100%; padding: 0.5rem 1rem; background: #137fec; color: white; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 0.75rem; font-weight: 500; transition: background 0.2s;" 
                                    onmouseover="this.style.backgroundColor='#0d6fd8'"
                                    onmouseout="this.style.backgroundColor='#137fec'">
                                Detayları Gör
                            </button>
                        </div>
                    `;
                    
                    const popup = L.popup({
                        className: 'custom-popup',
                        closeButton: true,
                        autoClose: false,
                        closeOnClick: false,
                        maxWidth: 300
                    }).setContent(popupContent);
                    
                    mapMarker.bindPopup(popup);
                    
                    markers.push(mapMarker);
                }
            });
            
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                turkeyMap.fitBounds(group.getBounds().pad(0.1));
            } else {
                turkeyMap.setView([39.0, 35.0], 6);
            }
            
            const itemsToShow = window.innerWidth > 1536 ? 8 : window.innerWidth > 1024 ? 6 : 4;
            displayItems(items.slice(0, itemsToShow), container, true);
            
        }, (error) => {
            console.error("Harita verisi yükleme hatası:", error);
            container.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <span class="material-symbols-outlined text-gray-400">error</span>
                    </div>
                    <p class="text-sm text-gray-400">Harita verileri yüklenirken bir hata oluştu.</p>
                </div>
            `;
        });
    }

    window.handleMapPopupDetail = (itemId) => {
        if (currentPopup && turkeyMap) {
            turkeyMap.closePopup(currentPopup);
            currentPopup = null;
        }
        showItemDetailPopup(itemId);
    };

    // --- Item Management ---
    window.setAdType = (type) => {
        adType = type;
        const lostBtn = document.getElementById('type-lost');
        const foundBtn = document.getElementById('type-found');
        
        if (type === 'lost') {
            lostBtn.classList.add('border-lost-red', 'text-lost-red', 'font-bold');
            lostBtn.classList.remove('text-text-light');
            
            foundBtn.classList.remove('border-found-green', 'text-found-green', 'hover:border-found-green', 'hover:text-found-green', 'font-bold');
            foundBtn.classList.add('border', 'text-text-light');
        } else {
            foundBtn.classList.add('border-found-green', 'text-found-green', 'hover:border-found-green', 'hover:text-found-green', 'font-bold');
            foundBtn.classList.remove('text-text-light');
            
            lostBtn.classList.remove('border-lost-red', 'text-lost-red', 'font-bold');
            lostBtn.classList.add('border', 'text-text-light');
        }
    };

    window.saveAd = async () => {
        if (!currentUser) {
            alert("Lütfen önce giriş yapın.");
            showPage('home');
            document.getElementById('auth-modal').classList.remove('hidden');
            return;
        }
        
        const title = document.getElementById('add-title').value.trim();
        const desc = document.getElementById('add-desc').value.trim();
        const phone = document.getElementById('add-phone').value.trim();
        
        if (!title) {
            alert("Lütfen başlık girin.");
            return;
        }
        
        if (!selectedImage) {
            alert("Lütfen bir fotoğraf yükleyin.");
            return;
        }
        
        if (!phone) {
            alert("Lütfen iletişim numarası girin.");
            return;
        }
        
        // Konum kontrolü
        if (!selectedLat || !selectedLng) {
            const confirmNoLocation = confirm("Konum seçmediniz. Rastgele bir Türkiye konumu atansın mı? (Önerilmez)\n\nHaritadan konum seçmek için 'İptal' diyip konum seçebilirsiniz.");
            if (!confirmNoLocation) {
                openLocationPicker();
                return;
            }
            // Rastgele Türkiye konumu
            selectedLat = 39.0 + (Math.random() - 0.5) * 2;
            selectedLng = 35.0 + (Math.random() - 0.5) * 3;
        }
        
        const btn = document.getElementById('save-btn');
        const btnText = document.getElementById('save-btn-text');
        const originalText = btnText.textContent;
        btnText.textContent = "Yükleniyor...";
        btn.disabled = true;
        
        showLoading();
        
        try {
            const reader = new FileReader();
            reader.onload = async (event) => {
                const base64Image = event.target.result;
                
                const newItemRef = push(ref(db, 'items'));
                await set(newItemRef, {
                    id: newItemRef.key,
                    title,
                    description: desc,
                    phone,
                    type: adType,
                    image: base64Image,
                    lat: selectedLat,
                    lng: selectedLng,
                    address: selectedAddress,
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    userName: currentUser.displayName || currentUser.email.split('@')[0],
                    status: 'active',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });
                
                // Formu sıfırla
                document.getElementById('add-title').value = '';
                document.getElementById('add-desc').value = '';
                document.getElementById('add-phone').value = '';
                document.getElementById('image-preview').classList.add('hidden');
                selectedImage = null;
                document.getElementById('file-input').value = '';
                resetLocationSelection();
                
                alert("🎉 İlan başarıyla yayınlandı!");
                showPage('home');
                
                btnText.textContent = originalText;
                btn.disabled = false;
                hideLoading();
            };
            reader.readAsDataURL(selectedImage);
            
        } catch (error) {
            console.error("İlan kaydetme hatası:", error);
            alert("İlan kaydedilirken bir hata oluştu.");
            btnText.textContent = originalText;
            btn.disabled = false;
            hideLoading();
        }
    };

    // --- Item Display ---
    function loadRecentItems() {
        const container = document.getElementById('recent-items');
        container.innerHTML = '<div class="col-span-full text-center py-12"><div class="loading-spinner mx-auto"></div></div>';
        
        onValue(ref(db, 'items'), (snapshot) => {
            allItems = [];
            snapshot.forEach((child) => {
                const item = child.val();
                allItems.push(item);
            });
            
            allItems.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            const recentCount = window.innerWidth > 1536 ? 4 : window.innerWidth > 1024 ? 3 : 3;
            const recentItems = allItems.slice(0, recentCount);
            
            displayItems(recentItems, container);
        }, (error) => {
            console.error("Veri yükleme hatası:", error);
            container.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <span class="material-symbols-outlined text-gray-400">error</span>
                    </div>
                    <p class="text-sm text-gray-400">İlanlar yüklenirken bir hata oluştu.</p>
                </div>
            `;
        });
    }

    window.loadExploreItems = () => {
        const container = document.getElementById('explore-items');
        container.innerHTML = '<div class="col-span-full text-center py-12"><div class="loading-spinner mx-auto"></div></div>';
        
        onValue(ref(db, 'items'), (snapshot) => {
            allItems = [];
            snapshot.forEach((child) => {
                const item = child.val();
                allItems.push(item);
            });
            
            allItems.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // Filtreleme
            let filteredItems = allItems;
            
            if (currentFilter !== 'all') {
                filteredItems = filteredItems.filter(item => item.type === currentFilter);
            }
            
            // Arama filtresi
            if (searchTerm) {
                filteredItems = filteredItems.filter(item => 
                    item.title.toLowerCase().includes(searchTerm) ||
                    item.description.toLowerCase().includes(searchTerm)
                );
            }
            
            displayItems(filteredItems, container);
        });
    };

    function displayItems(items, container, fromMap = false) {
        if (items.length === 0) {
            container.innerHTML = `
                <div class="col-span-full text-center py-12">
                    <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <span class="material-symbols-outlined text-gray-400">search_off</span>
                    </div>
                    <p class="text-sm text-gray-400">${searchTerm ? 'Aramanızla eşleşen ilan bulunamadı.' : 'Henüz ilan bulunmuyor.'}</p>
                    <button onclick="showPage('add')" class="mt-3 px-4 py-1.5 bg-primary text-white text-xs rounded-lg">
                        İlk İlanı Sen Ver
                    </button>
                </div>
            `;
            return;
        }
        
        container.innerHTML = items.map(item => `
            <div class="group cursor-pointer" onclick="showItemDetailPopup('${item.id}')">
                <div class="relative aspect-[4/5] overflow-hidden rounded-xl bg-white shadow-md">
                    <img src="${item.image}" alt="${item.title}" class="h-full w-full object-cover group-hover:scale-[1.02] transition-transform duration-700">
                    <div class="absolute top-4 left-4">
                        <span class="px-3 py-1 bg-white/90 backdrop-blur-sm text-xs uppercase tracking-widest font-bold ${item.type === 'lost' ? 'text-lost-red' : 'text-found-green'} rounded-lg">
                            ${item.type === 'lost' ? 'Kayıp' : 'Bulundu'}
                        </span>
                    </div>
                    ${fromMap ? `<div class="absolute bottom-4 right-4">
                        <button onclick="event.stopPropagation(); showItemDetailPopup('${item.id}')" class="size-10 bg-black/80 backdrop-blur-sm rounded-full flex items-center justify-center text-white hover:bg-black transition">
                            <span class="material-symbols-outlined text-base">visibility</span>
                        </button>
                    </div>` : ''}
                </div>
                <div class="mt-4 flex justify-between items-start">
                    <div class="flex-1">
                        <h3 class="text-lg font-bold line-clamp-1">${item.title}</h3>
                        <p class="text-xs text-text-light mt-1">
                            ${item.phone ? '📞 ' + item.phone : 'İletişim yok'}
                        </p>
                        <p class="text-sm text-gray-500 mt-2 line-clamp-2">${item.description || 'Açıklama yok'}</p>
                    </div>
                    <span class="text-xs text-gray-400 ml-2 flex-shrink-0">${formatDate(item.createdAt)}</span>
                </div>
            </div>
        `).join('');
    }

    // --- Item Detail Popup (YENİ TEMA) ---
    window.showItemDetailPopup = async (itemId) => {
        if (currentPopup && turkeyMap) {
            turkeyMap.closePopup(currentPopup);
            currentPopup = null;
        }
        
        showLoading();
        try {
            const snapshot = await get(ref(db, `items/${itemId}`));
            if (!snapshot.exists()) {
                alert("İlan bulunamadı.");
                hideLoading();
                return;
            }
            
            const item = snapshot.val();
            
            const detailModal = document.getElementById('detail-modal');
            const detailContent = detailModal.querySelector('.detail-popup-container');
            
            detailContent.innerHTML = `
                <div class="detail-image-container">
                    <img src="${item.image}" alt="${item.title}" class="detail-image">
                    <div class="detail-badge ${item.type === 'lost' ? 'lost-badge' : 'found-badge'}">
                        ${item.type === 'lost' ? 'Kayıp' : 'Bulundu'}
                    </div>
                </div>
                
                <div class="detail-content">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h1 class="detail-title">${item.title}</h1>
                            <div class="detail-meta">
                                <span class="material-symbols-outlined text-sm">schedule</span>
                                <span>${formatDate(item.createdAt)}</span>
                            </div>
                        </div>
                        <button onclick="closeDetailModal()" class="modal-close-btn">
                            <span class="material-symbols-outlined text-xl">close</span>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="space-y-6">
                            <div class="detail-section">
                                <h3 class="section-title">Açıklama</h3>
                                <div class="section-content">
                                    ${item.description || 'Açıklama yok'}
                                </div>
                            </div>
                            
                            <div class="detail-section">
                                <h3 class="section-title">İletişim</h3>
                                <div class="contact-info">
                                    <span class="material-symbols-outlined">call</span>
                                    <span>${item.phone || 'İletişim numarası yok'}</span>
                                </div>
                            </div>
                            
                            <div onclick="showProfile('${item.userId}')" class="user-info">
                                <img src="${item.userProfileImage || 'https://lh3.googleusercontent.com/aida-public/AB6AXuAHgmz9ZdyrrnVStj22LkErbA8T2RxayfdXNwm9XagSatARcd3ffXC_gnMjwdMeTVIM1_naprdoDBH5E3oQbSpPToZ9pFGChkcvGo7fUPwhQIeIDqqxkhg_0GG1S_EIbuKM63LbIbQBaMofSj_XkXehUr35iKp9AOfl7D_5tV9hf9L31MrtXPhZTrnFNVIgStVmeBJPzZwRvfbNPNyWtRAxeHdGww_HnK4TbZVi8SjQ246qUt_7_Kf_MPPuOxI2yvPYY3om-iE61Vc'}" 
                                     alt="${item.userName}" class="user-avatar">
                                <div class="user-details">
                                    <p>${item.userName || 'Kullanıcı'}</p>
                                    <p>${item.userEmail || ''}</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-6">
                            <div class="detail-section">
                                <h3 class="section-title">Konum</h3>
                                <div id="detail-map-mini" class="map-mini"></div>
                                <p class="text-xs text-text-light mt-2">
                                    <span class="material-symbols-outlined text-sm">location_on</span>
                                    ${item.address || `Koordinatlar: ${item.lat?.toFixed(4) || '0'}, ${item.lng?.toFixed(4) || '0'}`}
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    ${currentUser && item.userId === currentUser.uid && item.type === 'lost' ? `
                        <div class="action-buttons">
                            <button onclick="markAsFound('${itemId}')" 
                                    class="primary-button success-button">
                                <span class="material-symbols-outlined">check_circle</span>
                                Bulundu Olarak İşaretle
                            </button>
                            <button onclick="deleteItem('${itemId}')" 
                                    class="secondary-button danger-button">
                                <span class="material-symbols-outlined">delete</span>
                                İlanı Sil
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
            
            detailModal.classList.remove('hidden');
            
            // Mini haritayı başlat
            setTimeout(() => {
                const miniMap = L.map('detail-map-mini').setView([item.lat || 39.0, item.lng || 35.0], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(miniMap);
                
                const miniMarker = L.marker([item.lat || 39.0, item.lng || 35.0], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background-color: ${item.type === 'lost' ? '#dc2626' : '#059669'}; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: flex; align-items: center; justify-content: center;">
                                 <span class="material-symbols-outlined" style="color: white; font-size: 16px;">
                                     ${item.type === 'lost' ? 'search' : 'check'}
                                 </span>
                               </div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    })
                }).addTo(miniMap);
                
                miniMap.invalidateSize();
            }, 100);
            
            hideLoading();
            
        } catch (error) {
            console.error("Detay yükleme hatası:", error);
            alert("İlan detayları yüklenirken bir hata oluştu.");
            hideLoading();
        }
    };

    window.markAsFound = async (itemId) => {
        if (confirm("Bu ilanı bulundu olarak işaretlemek istediğinize emin misiniz?")) {
            showLoading();
            try {
                await update(ref(db, `items/${itemId}`), {
                    type: 'found',
                    updatedAt: new Date().toISOString()
                });
                alert("✅ Başarıyla güncellendi!");
                closeDetailModal();
                if (document.getElementById('page-profile').classList.contains('hidden')) {
                    showPage('explore');
                } else {
                    loadProfilePage();
                }
            } catch (error) {
                console.error("Güncelleme hatası:", error);
                alert("Güncelleme sırasında bir hata oluştu.");
            } finally {
                hideLoading();
            }
        }
    };

    window.deleteItem = async (itemId) => {
        if (confirm("Bu ilanı silmek istediğinize emin misiniz? Bu işlem geri alınamaz.")) {
            showLoading();
            try {
                await remove(ref(db, `items/${itemId}`));
                alert("🗑️ İlan başarıyla silindi!");
                closeDetailModal();
                if (document.getElementById('page-profile').classList.contains('hidden')) {
                    showPage('explore');
                } else {
                    loadProfilePage();
                }
            } catch (error) {
                console.error("Silme hatası:", error);
                alert("İlan silinirken bir hata oluştu.");
            } finally {
                hideLoading();
            }
        }
    };

    // --- Profile Management ---
    function loadProfilePage() {
        const container = document.getElementById('profile-content');
        container.innerHTML = `
            <div class="flex flex-col items-center justify-center py-12">
                <div class="loading-spinner mb-3"></div>
                <p class="text-sm text-text-light">Yükleniyor...</p>
            </div>
        `;
        
        setTimeout(() => {
            showProfile(currentUser.uid);
        }, 300);
    }

    window.showProfile = async (userId) => {
        showLoading();
        try {
            const userSnap = await get(ref(db, `users/${userId}`));
            const userData = userSnap.val();
            
            const itemsSnap = await get(ref(db, 'items'));
            const userItems = [];
            itemsSnap.forEach((child) => {
                const item = child.val();
                if (item.userId === userId) {
                    userItems.push(item);
                }
            });
            
            const container = document.getElementById('profile-content');
            
            userItems.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            const totalAds = userItems.length;
            const lostAds = userItems.filter(item => item.type === 'lost').length;
            const foundAds = userItems.filter(item => item.type === 'found').length;
            
            container.innerHTML = `
                <div class="mb-8">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
                        <div>
                            <h2 class="text-2xl font-bold mb-2">${userData?.name || 'Kullanıcı'}</h2>
                            <p class="text-sm text-text-light">${userData?.email || currentUser?.email || ''}</p>
                            ${userData?.bio ? `<p class="text-sm text-gray-600 mt-2">${userData.bio}</p>` : ''}
                            ${userData?.contact ? `<p class="text-sm text-gray-500 mt-1">📞 ${userData.contact}</p>` : ''}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openProfileEditModal()" class="primary-button px-6">
                                Profili Düzenle
                            </button>
                            <button onclick="logout()" class="secondary-button px-6">
                                Çıkış Yap
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 mb-8">
                        <div class="bg-gray-50 p-4 rounded-xl text-center">
                            <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Toplam</p>
                            <p class="text-2xl font-bold">${totalAds}</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-xl text-center">
                            <p class="text-xs text-red-500 uppercase tracking-wider mb-1">Kayıp</p>
                            <p class="text-2xl font-bold text-red-500">${lostAds}</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-xl text-center">
                            <p class="text-xs text-green-500 uppercase tracking-wider mb-1">Bulunan</p>
                            <p class="text-2xl font-bold text-green-500">${foundAds}</p>
                        </div>
                    </div>
                    
                    <div class="mb-8">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold">İlanlarım</h3>
                            <button onclick="showPage('add')" class="primary-button px-4 py-2">
                                + Yeni İlan
                            </button>
                        </div>
                        
                        <div id="prof-ads" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${userItems.length > 0 ? userItems.map(item => `
                                <div class="bg-white rounded-xl overflow-hidden shadow-sm cursor-pointer hover:shadow-md transition" onclick="showItemDetailPopup('${item.id}')">
                                    <div class="relative h-48 bg-gray-100">
                                        <img src="${item.image}" alt="${item.title}" class="w-full h-full object-cover">
                                        <div class="absolute top-2 left-2">
                                            <span class="px-2 py-0.5 ${item.type === 'lost' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'} text-xs uppercase tracking-wider rounded">
                                                ${item.type === 'lost' ? 'Kayıp' : 'Bulundu'}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="p-3">
                                        <h4 class="font-bold text-sm mb-1 line-clamp-1">${item.title}</h4>
                                        <p class="text-xs text-gray-500 mb-2 line-clamp-2">${item.description?.substring(0, 80) || ''}</p>
                                        <div class="flex items-center justify-between">
                                            <span class="text-xs text-gray-400">${formatDate(item.createdAt)}</span>
                                            ${item.type === 'lost' ? `
                                                <button onclick="event.stopPropagation(); markAsFound('${item.id}')" 
                                                        class="px-2 py-1 bg-green-100 text-green-600 text-xs rounded hover:bg-green-200 transition">
                                                    ✅ Bulundu
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('') : `
                                <div class="col-span-full text-center py-12">
                                    <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                                        <span class="material-symbols-outlined text-gray-400">inbox</span>
                                    </div>
                                    <p class="text-sm text-gray-400 mb-4">Henüz ilan bulunmuyor.</p>
                                    <button onclick="showPage('add')" class="primary-button px-6">
                                        İlk İlanını Ver
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
            
            hideLoading();
            
        } catch (error) {
            console.error("Profil yükleme hatası:", error);
            container.innerHTML = `
                <div class="text-center py-12">
                    <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
                        <span class="material-symbols-outlined text-gray-400">error</span>
                    </div>
                    <p class="text-sm text-gray-400">Profil yüklenirken bir hata oluştu.</p>
                </div>
            `;
            hideLoading();
        }
    };

    window.openProfileEditModal = async () => {
        showLoading();
        try {
            const userSnap = await get(ref(db, `users/${currentUser.uid}`));
            const userData = userSnap.val();
            
            const modal = document.getElementById('profile-edit-modal');
            modal.innerHTML = `
                <div class="profile-edit-container">
                    <div class="modal-header">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center">
                                    <span class="material-symbols-outlined text-white">person</span>
                                </div>
                                <div>
                                    <h2 class="modal-title">Profili Düzenle</h2>
                                    <p class="text-sm text-text-light">Profil bilgilerinizi güncelleyin</p>
                                </div>
                            </div>
                            <button onclick="closeProfileEditModal()" class="modal-close-btn">
                                <span class="material-symbols-outlined text-xl">close</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="modal-body">
                        <div class="space-y-6">
                            <div class="flex flex-col items-center">
                                <div class="profile-avatar-container">
                                    <img id="profile-preview" src="${userData?.profileImage || 'https://lh3.googleusercontent.com/aida-public/AB6AXuAHgmz9ZdyrrnVStj22LkErbA8T2RxayfdXNwm9XagSatARcd3ffXC_gnMjwdMeTVIM1_naprdoDBH5E3oQbSpPToZ9pFGChkcvGo7fUPwhQIeIDqqxkhg_0GG1S_EIbuKM63LbIbQBaMofSj_XkXehUr35iKp9AOfl7D_5tV9hf9L31MrtXPhZTrnFNVIgStVmeBJPzZwRvfbNPNyWtRAxeHdGww_HnK4TbZVi8SjQ246qUt_7_Kf_MPPuOxI2yvPYY3om-iE61Vc'}" 
                                         class="profile-avatar">
                                    <button onclick="document.getElementById('profile-image-input').click()" 
                                            class="avatar-edit-btn">
                                        <span class="material-symbols-outlined text-sm">photo_camera</span>
                                    </button>
                                </div>
                                <input type="file" id="profile-image-input" class="hidden" accept="image/*">
                                <p class="text-xs text-text-light">Profil fotoğrafı değiştir</p>
                            </div>
                            
                            <div>
                                <label class="form-label">Ad Soyad</label>
                                <input type="text" id="edit-name" value="${userData?.name || ''}" 
                                       class="form-input">
                            </div>
                            
                            <div>
                                <label class="form-label">Bio</label>
                                <textarea id="edit-bio" rows="3" 
                                          class="form-input">${userData?.bio || ''}</textarea>
                                <p class="text-xs text-text-light mt-1">Kendiniz hakkında kısa bir açıklama</p>
                            </div>
                            
                            <div>
                                <label class="form-label">İletişim Bilgileri</label>
                                <input type="text" id="edit-contact" value="${userData?.contact || ''}" 
                                       class="form-input">
                                <p class="text-xs text-text-light mt-1">Telefon numarası veya diğer iletişim bilgileri</p>
                            </div>
                            
                            <div>
                                <label class="form-label">E-posta</label>
                                <input type="email" value="${currentUser?.email || ''}" disabled
                                       class="form-input bg-gray-100">
                                <p class="text-xs text-text-light mt-1">E-posta değiştirilemez</p>
                            </div>
                            
                            <div class="pt-4">
                                <button onclick="saveProfileChanges()" class="primary-button">
                                    Değişiklikleri Kaydet
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
            
            // Profil fotoğrafı yükleme
            document.getElementById('profile-image-input').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        alert("Dosya boyutu 5MB'tan küçük olmalıdır.");
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        document.getElementById('profile-preview').src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            hideLoading();
            
        } catch (error) {
            console.error("Profil düzenleme modalı yükleme hatası:", error);
            alert("Profil düzenleme sayfası yüklenirken bir hata oluştu.");
            hideLoading();
        }
    };

    window.saveProfileChanges = async () => {
        showLoading();
        
        try {
            const name = document.getElementById('edit-name').value.trim();
            const bio = document.getElementById('edit-bio').value.trim();
            const contact = document.getElementById('edit-contact').value.trim();
            const profileImageInput = document.getElementById('profile-image-input');
            
            const updates = {
                name: name || currentUser.email.split('@')[0],
                bio: bio,
                contact: contact,
                updatedAt: new Date().toISOString()
            };
            
            // Profil fotoğrafı güncelleme
            if (profileImageInput.files[0]) {
                const file = profileImageInput.files[0];
                const reader = new FileReader();
                
                reader.onload = async (event) => {
                    updates.profileImage = event.target.result;
                    
                    // Firebase Authentication'daki display name'i güncelle
                    await updateProfile(currentUser, {
                        displayName: updates.name
                    });
                    
                    // Database'de güncelle
                    await update(ref(db, `users/${currentUser.uid}`), updates);
                    
                    // Başarı mesajı
                    alert("✅ Profil başarıyla güncellendi!");
                    closeProfileEditModal();
                    loadProfilePage();
                    
                    // Header'ı güncelle
                    const headerImg = document.getElementById('header-profile-img');
                    if (headerImg) {
                        headerImg.src = updates.profileImage;
                    }
                    
                    hideLoading();
                };
                
                reader.readAsDataURL(file);
            } else {
                // Firebase Authentication'daki display name'i güncelle
                await updateProfile(currentUser, {
                    displayName: updates.name
                });
                
                // Database'de güncelle
                await update(ref(db, `users/${currentUser.uid}`), updates);
                
                // Başarı mesajı
                alert("✅ Profil başarıyla güncellendi!");
                closeProfileEditModal();
                loadProfilePage();
                hideLoading();
            }
            
        } catch (error) {
            console.error("Profil güncelleme hatası:", error);
            alert("Profil güncelleme sırasında bir hata oluştu: " + error.message);
            hideLoading();
        }
    };

    // --- Search and Filter ---
    window.setFilter = (filter) => {
        currentFilter = filter;
        
        ['lost', 'found', 'all'].forEach(f => {
            const btn = document.getElementById(`filter-${f}`);
            if (btn) {
                if (f === filter) {
                    btn.classList.remove('bg-white', 'text-lost-red', 'text-found-green', 'border');
                    btn.classList.add('bg-primary', 'text-white');
                } else if (f === 'lost') {
                    btn.classList.remove('bg-primary', 'text-white', 'bg-white', 'text-found-green', 'border');
                    btn.classList.add('bg-white', 'text-lost-red', 'border');
                } else if (f === 'found') {
                    btn.classList.remove('bg-primary', 'text-white', 'bg-white', 'text-lost-red', 'border');
                    btn.classList.add('bg-white', 'text-found-green', 'border');
                }
            }
        });
        
        loadExploreItems();
    };

    // --- Auth State Listener ---
    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        
        if (user) {
            document.getElementById('auth-modal').classList.add('hidden');
            
            get(ref(db, `users/${user.uid}`)).then((snap) => {
                const userData = snap.val();
                
                document.getElementById('header-profile').innerHTML = `
                    <div class="flex items-center gap-3">
                        <button onclick="showPage('profile')" class="size-10 overflow-hidden rounded-full ring-2 ring-primary">
                            <img id="header-profile-img" class="h-full w-full object-cover" 
                                 src="${userData?.profileImage || 'https://lh3.googleusercontent.com/aida-public/AB6AXuAHgmz9ZdyrrnVStj22LkErbA8T2RxayfdXNwm9XagSatARcd3ffXC_gnMjwdMeTVIM1_naprdoDBH5E3oQbSpPToZ9pFGChkcvGo7fUPwhQIeIDqqxkhg_0GG1S_EIbuKM63LbIbQBaMofSj_XkXehUr35iKp9AOfl7D_5tV9hf9L31MrtXPhZTrnFNVIgStVmeBJPzZwRvfbNPNyWtRAxeHdGww_HnK4TbZVi8SjQ246qUt_7_Kf_MPPuOxI2yvPYY3om-iE61Vc'}">
                        </button>
                    </div>
                `;
            }).catch(() => {
                document.getElementById('header-profile').innerHTML = `
                    <div class="flex items-center gap-3">
                        <button onclick="showPage('profile')" class="size-10 overflow-hidden rounded-full ring-2 ring-primary">
                            <img id="header-profile-img" class="h-full w-full object-cover" 
                                 src="https://lh3.googleusercontent.com/aida-public/AB6AXuAHgmz9ZdyrrnVStj22LkErbA8T2RxayfdXNwm9XagSatARcd3ffXC_gnMjwdMeTVIM1_naprdoDBH5E3oQbSpPToZ9pFGChkcvGo7fUPwhQIeIDqqxkhg_0GG1S_EIbuKM63LbIbQBaMofSj_XkXehUr35iKp9AOfl7D_5tV9hf9L31MrtXPhZTrnFNVIgStVmeBJPzZwRvfbNPNyWtRAxeHdGww_HnK4TbZVi8SjQ246qUt_7_Kf_MPPuOxI2yvPYY3om-iE61Vc">
                        </button>
                    </div>
                `;
            });
            
            loadRecentItems();
            
        } else {
            document.getElementById('auth-modal').classList.remove('hidden');
            document.getElementById('header-profile').innerHTML = `
                <button onclick="document.getElementById('auth-modal').classList.remove('hidden')"
                        class="px-4 py-2 bg-primary text-white text-sm font-bold rounded-lg">
                    Giriş Yap
                </button>
            `;
        }
    });

</script>
</body>
</html>
